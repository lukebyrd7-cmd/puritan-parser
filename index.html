<!-- BEGIN PP DIAGNOSTIC TOOL (TEMP - REMOVE AFTER DEBUG) -->
<style>
  #ppDiag { position: fixed; right: 12px; top: 12px; width: 320px; max-height: 70vh; overflow:auto; z-index:99999;
            background: rgba(255,255,255,0.98); border:1px solid rgba(0,0,0,0.08); padding:10px; border-radius:10px;
            font-family:system-ui; font-size:13px; color:#111; box-shadow:0 6px 20px rgba(0,0,0,0.12); }
  #ppDiag h4{margin:0 0 8px 0;font-size:14px}
  #ppDiag button{margin:4px 2px;padding:6px 8px;border-radius:8px;border:1px solid #ddd;background:#f7f7f7;cursor:pointer}
  #ppDiag pre{white-space:pre-wrap;background:#fafafa;border-radius:6px;padding:6px;border:1px solid #eee;margin-top:6px}
</style>
<div id="ppDiag" aria-live="polite" role="status">
  <h4>Puritan Parser — Diagnostics</h4>
  <div>
    <button id="pp_test_json">Test JSON endpoints</button>
    <button id="pp_unreg_sw">Unregister SW</button>
    <button id="pp_clear_ls">Clear localStorage</button>
    <button id="pp_show_state">Show state</button>
  </div>
  <div id="ppDiagOut" style="margin-top:8px" />
</div>

<script>
(function(){
  const out = id => { document.getElementById('ppDiagOut').innerHTML = id; };
  window.addEventListener('error', e => {
    out('<strong>JS Error:</strong> ' + (e && e.message ? e.message : String(e)) + '<pre>' + (e && e.error && e.error.stack ? e.error.stack : '') + '</pre>');
    console.error('PP diag error', e);
  });
  window.addEventListener('unhandledrejection', ev => {
    out('<strong>Unhandled Rejection:</strong> ' + (ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason)) + '<pre>' + (ev.reason && ev.reason.stack ? ev.reason.stack : '') + '</pre>');
    console.error('PP diag unhandled rejection', ev);
  });

  async function testUrl(path){
    try {
      const url = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/') + path + '?t=' + Date.now();
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok) return `${path} -> HTTP ${r.status}`;
      const txt = await r.text();
      return `${path} -> OK, ${Math.min(200, txt.length)} chars (preview):\n${txt.slice(0,200)}`;
    } catch(err){
      return `${path} -> fetch error: ${err && err.message ? err.message : err}`;
    }
  }

  document.getElementById('pp_test_json').addEventListener('click', async ()=>{
    out('Testing JSON files...');
    const res1 = await testUrl('greek_25plus.json');
    const res2 = await testUrl('hebrew_60plus.json');
    const res3 = await testUrl('vocab_all.json');
    out('<pre>' + [res1, res2, res3].join('\n\n') + '</pre>');
  });

  document.getElementById('pp_unreg_sw').addEventListener('click', async ()=>{
    if(!('serviceWorker' in navigator)) { out('No serviceWorker API'); return; }
    out('Unregistering service worker(s)...');
    const regs = await navigator.serviceWorker.getRegistrations();
    if(!regs.length) { out('No SW registrations found'); return; }
    await Promise.all(regs.map(r => r.unregister()));
    // clear caches
    if('caches' in window){
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }
    out('Service worker(s) unregistered and caches cleared. Reload page.');
  });

  document.getElementById('pp_clear_ls').addEventListener('click', ()=>{
    if(!confirm('Clear localStorage?')) return;
    localStorage.clear();
    out('localStorage cleared. Reload page.');
  });

  document.getElementById('pp_show_state').addEventListener('click', ()=>{
    let ls = {};
    try { for(const k of Object.keys(localStorage)) ls[k] = localStorage.getItem(k); } catch(e){ ls = {error: e.message}; }
    out('<pre>' + JSON.stringify(ls, null, 2) + '</pre>');
  });

  // small visible banner to confirm script ran
  out('Diagnostic loaded. Use buttons above. (Remove this block after debug.)');
})();
</script>
<!-- END PP DIAGNOSTIC TOOL -->
  
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Puritan Parser</title>
<link rel="icon" href="./logo.png">
<style>
/* ---------- Theme & layout ---------- */
:root{
  --bg: #ffffff;
  --card: #fbfdfb;
  --muted: #6b7280;
  --text: #0f1720;
  --accent: #4e8f6e;
  --border: rgba(0,0,0,0.06);
  --radius: 12px;
  --shadow: 0 8px 20px rgba(15,23,32,0.06);
  --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --fs: 16px;
}
.dark{
  --bg:#071226; --card:#071827; --text:#e6eef2; --muted:#94a3b8; --border: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font-sans);background:var(--bg);color:var(--text);font-size:var(--fs);-webkit-font-smoothing:antialiased}
.app{max-width:1080px;margin:18px auto;padding:14px}
.header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.logo{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid var(--border)}
.title{font-weight:700}
.subtitle{font-size:13px;color:var(--muted)}
.topbar{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.lang-toggle{display:flex;gap:8px}
.lang-btn{padding:8px 10px;border-radius:10px;border:1px solid transparent;background:transparent;cursor:pointer}
.lang-btn.active{background:var(--accent);color:#fff;border-color:var(--border)}
.badge{background:var(--card);border:1px solid var(--border);padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}
.controls-row{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
.panel{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border)}
.row{display:flex;gap:8px;align-items:center}
.input, select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
.range{width:160px}
.muted{color:var(--muted)}
.table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
th{font-weight:700;color:var(--muted);font-size:13px}

/* views */
.view{display:none}
.view.active{display:block}

/* flashcard */
.flashcard{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:240px}
.card-word{font-size:34px;font-weight:800;text-align:center;margin-bottom:8px}
.card-meta{font-size:13px;color:var(--muted);text-align:center}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:12px}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--border)}
.small{padding:6px 8px;font-size:13px}
.rating-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.rating-btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);cursor:pointer;background:transparent}

/* parsing */
.parsing-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

/* settings page */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:700px){ .settings-grid{grid-template-columns:1fr} }

/* small helpers */
.hidden{display:none}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.focus{outline:3px solid rgba(78,143,110,0.16);outline-offset:2px}
.rtl{direction:rtl}

/* responsiveness */
@media (max-width:900px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app" id="app">
  <header class="header" role="banner">
    <div class="logo" id="logoWrap">
      <!-- tries logo.png; onerror injects svg fallback -->
      <img id="logoImg" src="./logo.png" alt="Puritan Parser logo" style="width:42px;height:42px;border-radius:8px" onerror="(function(){const s=document.createElement('div');s.innerHTML=svgFallback;const parent=document.getElementById('logoWrap');parent.innerHTML='';parent.appendChild(s.firstChild);})();">
    </div>
    <div>
      <div class="title">The Puritan Parser</div>
      <div class="subtitle">Greek (GNT) — Spaced Repetition & Parsing Practice</div>
    </div>
  </header>

  <div class="topbar" role="navigation" aria-label="Main controls">
    <div class="lang-toggle" role="tablist">
      <button class="lang-btn active" data-lang="greek" id="btnGreek">Greek (GNT)</button>
      <button class="lang-btn" data-lang="hebrew" id="btnHebrew">Hebrew</button>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div class="badge" id="dueBadge">Due: 0</div>
      <div class="badge" id="streakBadge">Streak: 0</div>
      <button class="btn ghost small" id="openDashboard">Dashboard</button>
      <button class="btn ghost small" id="openParsing">Parsing</button>
      <button class="btn small" id="openFlash">Flashcards</button>
      <button class="btn ghost small" id="openSettings">Settings</button>
    </div>
  </div>

  <div class="grid">
    <main class="panel" id="mainPanel" aria-live="polite">
      <!-- per-language controls -->
      <div class="controls-row">
        <div class="row" style="gap:10px">
          <div class="muted" id="langTag">Greek</div>
          <div class="muted" id="entriesCount">0 entries</div>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <input id="searchInput" class="input" placeholder="Search (word / lemma / gloss / pos)">
          <div style="display:flex;flex-direction:column;align-items:flex-start">
            <label class="muted" style="font-size:12px">Min freq</label>
            <div style="display:flex;align-items:center;gap:8px">
              <input id="freqSlider" class="range" type="range" min="1" max="50" value="1">
              <div class="muted" id="freqLabel">1+</div>
            </div>
          </div>
          <select id="sortSelect" class="input">
            <option value="freq-desc">freq ↓</option>
            <option value="freq-asc">freq ↑</option>
            <option value="word-az">word A→Z</option>
            <option value="word-za">word Z→A</option>
          </select>
        </div>
      </div>

      <!-- Views (only one visible at a time) -->
      <section id="listView" class="view active">
        <table class="table" aria-describedby="entriesCount">
          <thead><tr><th>word</th><th>lemma</th><th>gloss</th><th>pos</th><th>freq</th><th>due</th><th>ease</th><th>mastery</th></tr></thead>
          <tbody id="wordsTbody"></tbody>
        </table>
      </section>

      <section id="flashView" class="view">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="muted" id="flashProgress">0 / 0</div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">Study mode</label>
            <select id="studyMode" class="input">
              <option value="due">Due only</option>
              <option value="all">All filtered</option>
            </select>
            <label class="muted">Show gloss on front</label>
            <input type="checkbox" id="showGlossFront" />
          </div>
        </div>

        <div class="flashcard">
          <div class="card-word" id="cardWord">—</div>
          <div class="card-meta" id="cardMeta">pos • freq • due</div>
          <div class="actions">
            <button class="btn ghost small" id="revealBtn">Reveal</button>
            <button class="btn small" id="againBtn">Again</button>
          </div>
          <div class="rating-row" id="ratingRow"></div>
        </div>
      </section>

      <section id="parsingView" class="view">
        <div class="parsing-controls">
          <label class="muted">Mode</label>
          <select id="parsingMode" class="input">
            <option value="nouns">Nouns</option>
            <option value="verbs">Verbs</option>
            <option value="mixed">Mixed</option>
          </select>
          <label class="muted">Count</label>
          <input id="parsingCount" type="number" class="input" value="10" min="5" max="200" style="width:86px" />
          <button class="btn small" id="startParsing">Start</button>
        </div>

        <div class="panel" id="parsingWrap" style="min-height:180px">
          <div id="parsingQuestion" style="font-weight:700;font-size:18px;margin-bottom:8px">Press Start</div>
          <div id="parsingForm"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="muted" id="parsingProgress">0 / 0</div>
            <div style="display:flex;gap:8px">
              <button class="btn ghost small" id="nextParsing">Next</button>
              <button class="btn ghost small" id="endParsing">End</button>
            </div>
          </div>
        </div>
      </section>

      <section id="dashboardView" class="view">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div style="font-weight:700">Study Dashboard</div>
            <div class="muted">Summary and recommended session</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Due today</div>
            <div style="font-size:20px;font-weight:800" id="dashDue">0</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="panel">
            <div style="font-weight:700">Recent Performance</div>
            <canvas id="perfSpark" width="400" height="80" style="width:100%;height:60px"></canvas>
          </div>
          <div class="panel">
            <div style="font-weight:700">Stats</div>
            <div style="margin-top:8px">
              <div>Avg ease: <span id="avgEase">—</span></div>
              <div>Reviews this week: <span id="revWeek">0</span></div>
              <div>Study streak: <span id="dashStreak">0</span></div>
            </div>
          </div>
        </div>
      </section>

      <section id="settingsView" class="view">
        <div style="font-weight:700;margin-bottom:8px">Settings</div>
        <div class="settings-grid">
          <div class="panel">
            <div style="font-weight:700">UI</div>
            <div style="margin-top:8px">
              <label class="muted">Theme</label>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn ghost small theme-btn" data-theme="light">Light</button>
                <button class="btn ghost small theme-btn" data-theme="dark">Dark</button>
                <button class="btn ghost small theme-btn" data-theme="system">System</button>
              </div>
              <div style="margin-top:12px">
                <label class="muted">Accent color</label>
                <div id="accentPicker" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="customAccent" class="input" placeholder="#rrggbb" />
                  <button class="btn small" id="applyAccent">Apply</button>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div style="font-weight:700">SRS</div>
            <div style="margin-top:8px">
              <label class="muted"><input id="useSM2" type="checkbox" checked /> Use SM-2 algorithm</label>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label class="muted" style="width:120px">Initial ease</label>
                <input id="initialEase" class="input" type="number" step="0.1" value="2.5" style="width:86px" />
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label class="muted" style="width:120px">Min ease</label>
                <input id="minEase" class="input" type="number" step="0.1" value="1.3" style="width:86px" />
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label class="muted" style="width:120px">Daily cap</label>
                <input id="dailyCap" class="input" type="number" value="200" style="width:86px" />
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button class="btn small" id="saveSettings">Save</button>
          <button class="btn ghost small" id="cancelSettings">Cancel</button>
        </div>
      </section>

    </main>
  </div>

  <footer style="margin-top:12px;color:var(--muted);font-size:13px">The Puritan Parser — local-only data.</footer>
</div>

<!-- svg fallback for logo -->
<script>
const svgFallback = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 64 64" role="img" aria-label="Puritan Parser">
  <rect width="64" height="64" rx="12" fill="#4e8f6e"/>
  <text x="50%" y="54%" font-size="26" text-anchor="middle" fill="#fff" font-family="serif" font-weight="700">PP</text>
</svg>`;
</script>

<script>
/* ========= Application logic (single-file) =========
   - Fixed: parsing/dashboard/settings buttons functional
   - Settings moved to a separate view (hidden by default)
   - Per-language UI state stored separately to avoid mirroring
   - Keep other app files (sw.js, json) unchanged
*/

/* ---------- Keys & defaults ---------- */
const FILE_ALL = 'vocab_all.json';
const FILE_GREEK = 'greek_25plus.json';
const FILE_HEBREW = 'hebrew_60plus.json';
const LS_PREFS = 'pp_prefs_v2';
const LS_VOCAB_GREEK = 'pp_vocab_greek';
const LS_VOCAB_HEBREW = 'pp_vocab_hebrew';

const DEFAULTS = {
  accent: '#4e8f6e',
  theme: 'light',
  initialEase: 2.5,
  minEase: 1.3,
  useSM2: true,
  dailyCap: 200
};

/* ---------- State ---------- */
let state = {
  lang: 'greek',
  data: { greek: [], hebrew: [] },
  prefs: {},
  // per-language UI state prevents mirroring
  langUI: {
    greek: { search: '', freq: 1, sort: 'freq-desc' },
    hebrew: { search: '', freq: 1, sort: 'freq-desc' }
  },
  session: { queue: [], idx: 0, mode: 'due', showGlossFront: false },
  dashboard: { recent: [], streak: 0 }
};

/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function todayISO(offset=0){ const d=new Date(); d.setDate(d.getDate()+offset); return d.toISOString().slice(0,10); }
function uid(n=8){ return Math.random().toString(36).slice(2,2+n); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function daysBetween(a,b){ return Math.round((new Date(a)-new Date(b))/(1000*60*60*24)); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function debounce(fn,ms=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5); }

/* ---------- Prefs ---------- */
function loadPrefs(){
  try{
    const raw = localStorage.getItem(LS_PREFS);
    state.prefs = raw ? JSON.parse(raw) : {...DEFAULTS};
    state.prefs = Object.assign({}, DEFAULTS, state.prefs);
    applyTheme(state.prefs.theme);
    document.documentElement.style.setProperty('--accent', state.prefs.accent || DEFAULTS.accent);
  }catch(e){ state.prefs = {...DEFAULTS}; }
}
function savePrefs(){ localStorage.setItem(LS_PREFS, JSON.stringify(state.prefs)); }

/* ---------- Data loading ---------- */
async function tryFetchJson(path){
  try {
    const r = await fetch(path, {cache:'no-store'});
    if(!r.ok) throw new Error('not found');
    const j = await r.json(); if(!Array.isArray(j)) throw new Error('not array'); return j;
  } catch(e){ return null; }
}

function ensureSRS(item, lang){
  item.lang = lang;
  item.id = item.id || `${lang}-${uid(6)}`;
  if(typeof item.ease !== 'number') item.ease = state.prefs.initialEase || DEFAULTS.initialEase;
  if(typeof item.interval !== 'number') item.interval = 0;
  if(typeof item.repetitions !== 'number') item.repetitions = 0;
  if(!item.due) item.due = todayISO();
  if(!Array.isArray(item.history)) item.history = [];
  return item;
}

async function loadData(){
  // Try combined file first
  const all = await tryFetchJson(FILE_ALL);
  if(all && all.length){
    state.data.greek = all.filter(x => (x.lang||'greek').toLowerCase()==='greek').map(i=>ensureSRS(i,'greek'));
    state.data.hebrew = all.filter(x => (x.lang||'hebrew').toLowerCase()==='hebrew').map(i=>ensureSRS(i,'hebrew'));
    saveLangData('greek'); saveLangData('hebrew'); renderAll(); return;
  }
  const g = await tryFetchJson(FILE_GREEK);
  const h = await tryFetchJson(FILE_HEBREW);
  if(g && g.length) state.data.greek = g.map(i=>ensureSRS(i,'greek'));
  else {
    const raw = localStorage.getItem(LS_VOCAB_GREEK);
    state.data.greek = raw ? JSON.parse(raw) : [];
    state.data.greek = state.data.greek.map(i=>ensureSRS(i,'greek'));
  }
  if(h && h.length) state.data.hebrew = h.map(i=>ensureSRS(i,'hebrew'));
  else {
    const raw = localStorage.getItem(LS_VOCAB_HEBREW);
    state.data.hebrew = raw ? JSON.parse(raw) : [];
    state.data.hebrew = state.data.hebrew.map(i=>ensureSRS(i,'hebrew'));
  }
  saveLangData('greek'); saveLangData('hebrew');
  renderAll();
}

function saveLangData(lang){
  try{
    if(lang==='greek') localStorage.setItem(LS_VOCAB_GREEK, JSON.stringify(state.data.greek));
    if(lang==='hebrew') localStorage.setItem(LS_VOCAB_HEBREW, JSON.stringify(state.data.hebrew));
  }catch(e){}
}

/* ---------- SRS (SM-2) ---------- */
/* quality: 0..5 */
function sm2Update(item, q){
  item.history = item.history || [];
  item.history.push({date: todayISO(), q});
  if(q < 3){
    item.repetitions = 0;
    item.interval = 1;
  } else {
    item.repetitions = (item.repetitions || 0) + 1;
    if(item.repetitions === 1) item.interval = 1;
    else if(item.repetitions === 2) item.interval = 6;
    else item.interval = Math.round((item.interval || 1) * (item.ease || state.prefs.initialEase));
  }
  item.ease = (item.ease || state.prefs.initialEase) + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
  item.ease = clamp(item.ease, state.prefs.minEase, 10);
  const next = new Date(); next.setDate(next.getDate() + (item.interval || 1)); item.due = next.toISOString().slice(0,10);
  return item;
}

function leitnerUpdate(item, q){
  const ok = q >= 3;
  if(ok){ item.repetitions = (item.repetitions || 0) + 1; item.interval = Math.min(365, Math.max(1, Math.round(item.repetitions*2))); }
  else { item.repetitions = 0; item.interval = 1; }
  const next = new Date(); next.setDate(next.getDate() + (item.interval||1)); item.due = next.toISOString().slice(0,10);
  return item;
}

function scheduleUpdate(item, q){
  if(state.prefs.useSM2) return sm2Update(item,q);
  return leitnerUpdate(item,q);
}

/* ---------- Rendering: List ---------- */
function computeMastery(item){
  const reps = item.repetitions || 0;
  const ease = item.ease || (state.prefs.initialEase||2.5);
  const last = item.history && item.history.length ? item.history[item.history.length-1].date : item.due;
  const days = Math.max(0, daysBetween(todayISO(), last||todayISO()));
  const raw = (reps * ease) / (1 + days/30);
  const base = (state.prefs.initialEase||2.5);
  const score = Math.round(clamp(raw / base * 100, 0, 100));
  return score;
}

function renderList(){
  const ui = state.langUI[state.lang];
  $('#searchInput').value = ui.search || '';
  $('#freqSlider').value = ui.freq || 1;
  $('#freqLabel').textContent = (ui.freq>=50)?'50+': ui.freq + '+';
  $('#sortSelect').value = ui.sort || 'freq-desc';
  $('#langTag').textContent = state.lang === 'greek' ? 'Greek' : 'Hebrew';
  const list = (state.data[state.lang]||[]).filter(it => {
    const freqOk = (Number(it.freq||it.frequency||0) >= (ui.freq||1));
    const q = (ui.search||'').toLowerCase().trim();
    if(!q) return freqOk;
    const combined = `${it.word||it.lemma||''} ${it.lemma||''} ${it.gloss||''} ${it.pos||''}`.toLowerCase();
    return freqOk && combined.includes(q);
  }).slice();

  // sort
  const sort = ui.sort;
  list.sort((a,b)=>{
    if(sort==='freq-desc') return (b.freq||b.frequency||0)-(a.freq||a.frequency||0);
    if(sort==='freq-asc') return (a.freq||a.frequency||0)-(b.freq||b.frequency||0);
    if(sort==='word-az') return String(a.word||a.lemma||'').localeCompare(String(b.word||b.lemma||''));
    if(sort==='word-za') return String(b.word||b.lemma||'').localeCompare(String(a.word||a.lemma||''));
    return 0;
  });

  $('#entriesCount').textContent = `${list.length} entries`;
  const tbody = $('#wordsTbody'); tbody.innerHTML = '';
  if(!list.length){
    const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="8" class="muted">No entries found.</td>`; tbody.appendChild(tr); return;
  }
  const dueCount = list.filter(it => (it.due && it.due <= todayISO())).length;
  $('#dueBadge').textContent = `Due: ${dueCount}`; $('#dashDue').textContent = dueCount;

  for(const it of list){
    const word = escapeHtml(it.word||it.lemma||'');
    const lemma = escapeHtml(it.lemma||'');
    const gloss = escapeHtml(it.gloss||'');
    const pos = escapeHtml(it.pos||'');
    const freq = escapeHtml(String(it.freq||it.frequency||0));
    const due = escapeHtml(it.due||'—');
    const ease = (typeof it.ease === 'number') ? (it.ease.toFixed?it.ease.toFixed(2):String(it.ease)) : '—';
    const mastery = computeMastery(it);
    const cls = mastery > 60 ? 'high' : mastery > 25 ? 'mid' : 'low';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${word}</td>
                    <td>${lemma}</td>
                    <td>${gloss}</td>
                    <td>${pos}</td>
                    <td>${freq}</td>
                    <td>${due}</td>
                    <td>${ease}</td>
                    <td><span class="muted">${mastery}</span></td>`;
    tbody.appendChild(tr);
  }
}

/* ---------- Views management ---------- */
function showView(name){
  ['listView','flashView','parsingView','dashboardView','settingsView'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.toggle('active', id === name);
  });
  // focus first control when settings shown
  if(name === 'settingsView') document.getElementById('initialEase').focus();
  if(name !== 'settingsView') persistLangUI();
}

/* ---------- Flash session ---------- */
function startFlash(){
  const ui = state.langUI[state.lang];
  const mode = $('#studyMode').value;
  const minFreq = Number(ui.freq || 1);
  let pool = (state.data[state.lang]||[]).filter(it => (Number(it.freq||it.frequency||0) >= minFreq));
  if(mode === 'due') pool = pool.filter(it => it.due && it.due <= todayISO());
  if(!pool.length){ alert('No cards for this session. Try All filtered or reduce min frequency.'); return; }
  pool = shuffle(pool);
  const cap = Number(state.prefs.dailyCap||200);
  state.session.queue = pool.slice(0, cap);
  state.session.idx = 0;
  state.session.showGlossFront = !!$('#showGlossFront').checked;
  showView('flashView'); renderFlashCard();
}

function renderFlashCard(){
  const q = state.session.queue;
  $('#flashProgress').textContent = `${q.length?state.session.idx+1:0} / ${q.length||0}`;
  if(!q.length){ $('#cardWord').textContent = '—'; $('#cardMeta').textContent = 'No cards'; return; }
  const cur = q[state.session.idx];
  $('#cardWord').textContent = cur.word || cur.lemma || '—';
  const meta = [`${cur.pos||'—'}`, `freq ${cur.freq||cur.frequency||0}`, `due ${cur.due||'—'}`];
  $('#cardMeta').textContent = state.session.showGlossFront ? `${meta.join(' • ')}\n${cur.gloss||''}` : meta.join(' • ');
  $('#revealBtn').textContent = 'Reveal';
  // rating buttons
  const rr = $('#ratingRow'); rr.innerHTML = '';
  for(let i=0;i<=5;i++){
    const b = document.createElement('button');
    b.className = 'rating-btn';
    b.textContent = i===0? '0 (Forgot)' : i;
    b.addEventListener('click', ()=> onRate(i));
    rr.appendChild(b);
  }
}

function onReveal(){
  const cur = state.session.queue[state.session.idx];
  if(!cur) return;
  $('#cardMeta').textContent = `${cur.lemma||'—'} • ${cur.pos||'—'} • freq ${cur.freq||cur.frequency||0}\nGloss: ${cur.gloss||''}\nNext due: ${cur.due||'—'} • interval ${cur.interval||0}d`;
  $('#revealBtn').textContent = 'Hide';
}

function onAgain(){
  const idx = state.session.idx;
  const q = state.session.queue;
  const cur = q.splice(idx,1)[0];
  q.push(cur);
  if(idx >= q.length) state.session.idx = Math.max(0, q.length-1);
  renderFlashCard();
}

function onRate(quality){
  const cur = state.session.queue[state.session.idx];
  if(!cur) return;
  scheduleUpdate(cur, quality);
  saveLangData(state.lang);
  // remove from session (bury)
  state.session.queue.splice(state.session.idx,1);
  if(state.session.idx >= state.session.queue.length) state.session.idx = Math.max(0, state.session.queue.length-1);
  recordReview(quality);
  if(state.session.queue.length === 0){ alert('Session complete'); showView('listView'); renderList(); return; }
  renderFlashCard();
}

function recordReview(q){
  state.dashboard.recent = state.dashboard.recent || [];
  state.dashboard.recent.push({date: todayISO(), q});
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-60);
  state.dashboard.recent = state.dashboard.recent.filter(r => new Date(r.date) >= cutoff);
  // compute streak
  const uniqueDates = Array.from(new Set(state.dashboard.recent.map(r=>r.date))).sort().reverse();
  let streak = 0; let d = new Date();
  for(let i=0;i<365;i++){
    const iso = d.toISOString().slice(0,10);
    if(uniqueDates.includes(iso)){ streak++; d.setDate(d.getDate()-1); } else break;
  }
  state.dashboard.streak = streak;
  $('#streakBadge').textContent = `Streak: ${streak}`;
  localStorage.setItem('pp_dashboard_v2', JSON.stringify(state.dashboard));
}

/* ---------- Parsing ---------- */
let parsingSession = { questions: [], idx: 0, correct:0, total:0 };
function startParsing(){
  const mode = $('#parsingMode').value;
  const count = Number($('#parsingCount').value) || 10;
  const ui = state.langUI[state.lang];
  const minFreq = Number(ui.freq || 1);
  let pool = (state.data[state.lang]||[]).filter(it => (Number(it.freq||it.frequency||0) >= minFreq));
  if(mode === 'nouns') pool = pool.filter(it => (it.pos||'').toLowerCase().includes('n'));
  if(mode === 'verbs') pool = pool.filter(it => (it.pos||'').toLowerCase().includes('v'));
  if(!pool.length){ alert('No items for parsing with current filters.'); return; }
  pool = shuffle(pool).slice(0, Math.min(count, pool.length));
  parsingSession.questions = pool; parsingSession.idx = 0; parsingSession.correct = 0; parsingSession.total = pool.length;
  showView('parsingView'); renderParsingQuestion();
}

function renderParsingQuestion(){
  const idx = parsingSession.idx; const qn = parsingSession.questions[idx];
  if(!qn){ $('#parsingQuestion').textContent = 'Finished'; return; }
  $('#parsingQuestion').textContent = `Parse: ${qn.word || qn.lemma || ''}`;
  const form = $('#parsingForm'); form.innerHTML = '';
  // logic: if qn.parse exists, build specific fields, else simple lemma input
  if(qn.parse){
    if(qn.parse.toLowerCase().startsWith('n-') || (qn.pos||'').toLowerCase().includes('n')){
      ['case','number','gender','lemma'].forEach(f=>{
        const div = document.createElement('div'); div.style.marginBottom='8px';
        const label = document.createElement('label'); label.className='muted'; label.textContent = f;
        let input;
        if(f === 'lemma'){ input = document.createElement('input'); input.type='text'; input.className='input'; input.id = 'par_'+f; }
        else { input = document.createElement('select'); input.className='input'; input.id = 'par_'+f;
          const opts = f==='case'?['nom','acc','gen','dat','voc'] : f==='number'?['sg','pl'] : ['m','f','n'];
          opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; input.appendChild(op); });
        }
        div.appendChild(label); div.appendChild(input); form.appendChild(div);
      });
    } else {
      ['tense','mood','voice','person','lemma'].forEach(f=>{
        const div=document.createElement('div'); div.style.marginBottom='8px';
        const label=document.createElement('label'); label.className='muted'; label.textContent=f;
        const input=document.createElement('input'); input.type='text'; input.className='input'; input.id='par_'+f;
        div.appendChild(label); div.appendChild(input); form.appendChild(div);
      });
    }
  } else {
    const div=document.createElement('div'); div.style.marginBottom='8px';
    const label=document.createElement('label'); label.className='muted'; label.textContent='Lemma (type)';
    const input=document.createElement('input'); input.type='text'; input.className='input'; input.id='par_lemma';
    div.appendChild(label); div.appendChild(input); form.appendChild(div);
  }
  const submit=document.createElement('button'); submit.className='btn small'; submit.textContent='Submit';
  submit.addEventListener('click', (e)=>{ e.preventDefault(); checkParsingAnswer(qn); });
  form.appendChild(submit);
  $('#parsingProgress').textContent = `${idx+1} / ${parsingSession.total}`;
}

function checkParsingAnswer(qn){
  let correct=0, total=0, feedback=[];
  if(qn.parse){
    const p = qn.parse.toLowerCase();
    if(p.startsWith('n-') || (qn.pos||'').toLowerCase().includes('n')){
      const cas = $('#par_case')?$('#par_case').value:'';
      const num = $('#par_number')?$('#par_number').value:'';
      const gen = $('#par_gender')?$('#par_gender').value:'';
      const lemma = ($('#par_lemma')?$('#par_lemma').value:'').trim();
      total += 4;
      if(p.includes(cas)) correct++; else feedback.push(`Case expected part of "${p}"`);
      if(p.includes(num)) correct++; else feedback.push(`Number expected part of "${p}"`);
      if(p.includes(gen)) correct++; else feedback.push(`Gender expected part of "${p}"`);
      if((qn.lemma||'').toLowerCase() === lemma.toLowerCase()) correct++; else feedback.push(`Lemma expected "${qn.lemma}"`);
    } else {
      const tense = $('#par_tense')?$('#par_tense').value:'';
      const mood = $('#par_mood')?$('#par_mood').value:'';
      const voice = $('#par_voice')?$('#par_voice').value:'';
      const person = $('#par_person')?$('#par_person').value:'';
      const lemma = ($('#par_lemma')?$('#par_lemma').value:'').trim();
      total += 5;
      if(p.includes(tense)) correct++; else feedback.push(`Tense expected part of "${p}"`);
      if(p.includes(mood)) correct++; else feedback.push(`Mood expected part of "${p}"`);
      if(p.includes(voice)) correct++; else feedback.push(`Voice expected part of "${p}"`);
      if(p.includes(person)) correct++; else feedback.push(`Person expected part of "${p}"`);
      if((qn.lemma||'').toLowerCase() === lemma.toLowerCase()) correct++; else feedback.push(`Lemma expected "${qn.lemma}"`);
    }
  } else {
    total = 1; const lemma = ($('#par_lemma')?$('#par_lemma').value:'').trim();
    if((qn.lemma||'').toLowerCase() === lemma.toLowerCase()) correct=1; else feedback.push(`Lemma expected "${qn.lemma}"`);
  }
  parsingSession.idx++;
  if(correct === total) parsingSession.correct++;
  alert(`Score ${correct}/${total}\n${feedback.join('\n')}`);
  if(parsingSession.idx >= parsingSession.total){ alert(`Parsing session finished: ${parsingSession.correct}/${parsingSession.total}`); showView('listView'); return; }
  renderParsingQuestion();
}

/* ---------- Dashboard ---------- */
function renderDashboard(){
  const recent = state.dashboard.recent || [];
  $('#revWeek').textContent = recent.length || 0;
  $('#avgEase').textContent = computeAvgEase().toFixed?computeAvgEase().toFixed(2):'—';
  $('#dashStreak').textContent = state.dashboard.streak || 0;
  // sparkline
  const canvas = $('#perfSpark'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!recent.length) return;
  const arr = recent.slice(-30).map(r=>r.q);
  const w = canvas.width, h = canvas.height;
  ctx.beginPath(); arr.forEach((v,i)=>{ const x = (i/(arr.length-1))*w; const y = h - (v/5)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.strokeStyle = state.prefs.accent || '#4e8f6e'; ctx.lineWidth = 2; ctx.stroke();
}

function computeAvgEase(){
  const list = (state.data[state.lang]||[]);
  if(!list.length) return 0;
  const sum = list.reduce((s,it)=>(s + (Number(it.ease)||0)),0);
  return sum/list.length;
}

/* ---------- Settings ---------- */
const ACCENTS = ['#4e8f6e','#246b9c','#2a9d8f','#8a2b2b','#d97706','#475569','#6b21a8','#b91c1c','#0ea5a4','#ef4444','#f97316','#06b6d4'];
function renderAccentPicker(){
  const wrap = $('#accentPicker'); wrap.innerHTML = '';
  ACCENTS.forEach(hex=>{
    const b = document.createElement('button'); b.style.width='32px'; b.style.height='32px'; b.style.borderRadius='8px'; b.style.border='2px solid transparent'; b.style.background=hex; b.title = hex;
    b.addEventListener('click', ()=> { setAccent(hex); });
    wrap.appendChild(b);
  });
}
function setAccent(hex){
  document.documentElement.style.setProperty('--accent', hex);
  state.prefs.accent = hex; savePrefs();
}
function applyTheme(theme){
  state.prefs.theme = theme; savePrefs();
  document.documentElement.classList.remove('dark');
  if(theme === 'dark') document.documentElement.classList.add('dark');
  else if(theme === 'light') document.documentElement.classList.remove('dark');
  // system not handled explicitly here; default remains
}

/* Save settings UI -> prefs */
function saveSettingsFromUI(){
  state.prefs.useSM2 = !!$('#useSM2').checked;
  state.prefs.initialEase = Number($('#initialEase').value) || DEFAULTS.initialEase;
  state.prefs.minEase = Number($('#minEase').value) || DEFAULTS.minEase;
  state.prefs.dailyCap = Number($('#dailyCap').value) || DEFAULTS.dailyCap;
  savePrefs(); alert('Settings saved'); showView('listView');
}

/* ---------- Per-language UI persistence (prevents mirroring) ---------- */
function persistLangUI(){
  const ui = state.langUI[state.lang];
  ui.search = $('#searchInput').value || '';
  ui.freq = Number($('#freqSlider').value) || 1;
  ui.sort = $('#sortSelect').value || 'freq-desc';
}

function restoreLangUI(){
  const ui = state.langUI[state.lang];
  $('#searchInput').value = ui.search || '';
  $('#freqSlider').value = ui.freq || 1;
  $('#freqLabel').textContent = (ui.freq>=50)?'50+': ui.freq + '+';
  $('#sortSelect').value = ui.sort || 'freq-desc';
}

/* ---------- Wiring UI events ---------- */
function wire(){
  // language toggle
  $('#btnGreek').addEventListener('click', ()=> { persistLangUI(); state.lang='greek'; $('#btnGreek').classList.add('active'); $('#btnHebrew').classList.remove('active'); document.documentElement.dir='ltr'; restoreLangUI(); renderList(); });
  $('#btnHebrew').addEventListener('click', ()=> { persistLangUI(); state.lang='hebrew'; $('#btnHebrew').classList.add('active'); $('#btnGreek').classList.remove('active'); document.documentElement.dir='rtl'; restoreLangUI(); renderList(); });

  // controls
  $('#searchInput').addEventListener('input', debounce(()=> { persistLangUI(); renderList(); }, 200));
  $('#freqSlider').addEventListener('input', ()=> { $('#freqLabel').textContent = ($('#freqSlider').value>=50) ? '50+' : $('#freqSlider').value + '+'; persistLangUI(); renderList(); });

  $('#sortSelect').addEventListener('change', ()=> { persistLangUI(); renderList(); });

  // buttons (fixed: parsing/dashboard/settings)
  $('#openFlash').addEventListener('click', ()=> { persistLangUI(); startFlash(); });
  $('#openParsing').addEventListener('click', ()=> { persistLangUI(); showView('parsingView'); });
  $('#openDashboard').addEventListener('click', ()=> { persistLangUI(); renderDashboard(); showView('dashboardView'); });
  $('#openSettings').addEventListener('click', ()=> { persistLangUI(); populateSettingsUI(); showView('settingsView'); });

  // flash controls
  $('#revealBtn').addEventListener('click', ()=> { if($('#revealBtn').textContent==='Reveal') onReveal(); else renderFlashCard(); });
  $('#againBtn').addEventListener('click', onAgain);

  // parsing controls
  $('#startParsing').addEventListener('click', startParsing);
  $('#nextParsing').addEventListener('click', ()=> { parsingSession.idx++; renderParsingQuestion(); });
  $('#endParsing').addEventListener('click', ()=> { showView('listView'); });

  // settings UI
  $('#saveSettings').addEventListener('click', saveSettingsFromUI);
  $('#cancelSettings').addEventListener('click', ()=> { showView('listView'); });

  // theme buttons
  $$('.theme-btn').forEach(b => b.addEventListener('click', ()=> applyTheme(b.dataset.theme)));
  $('#applyAccent').addEventListener('click', ()=> { const v = ($('#customAccent').value||'').trim(); if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)){ setAccent(v); } else alert('Enter valid hex'); });

  // keyboard shortcuts (F Flash, P Parsing, D Dashboard, S Settings)
  document.addEventListener('keydown', (e)=>{
    if(e.key==='f' || e.key==='F'){ e.preventDefault(); $('#openFlash').click(); }
    if(e.key==='p' || e.key==='P'){ e.preventDefault(); $('#openParsing').click(); }
    if(e.key==='d' || e.key==='D'){ e.preventDefault(); $('#openDashboard').click(); }
    if(e.key==='s' || e.key==='S'){ e.preventDefault(); $('#openSettings').click(); }
    // rating keys during flash
    if(document.getElementById('flashView').classList.contains('active')){
      const k = Number(e.key);
      if(!isNaN(k) && k>=0 && k<=5){ onRate(k); }
    }
  });

  // persist on unload
  window.addEventListener('beforeunload', ()=> { persistLangUI(); savePrefs(); saveLangData('greek'); saveLangData('hebrew'); });
}

/* populate settings UI from prefs */
function populateSettingsUI(){
  $('#useSM2').checked = !!state.prefs.useSM2;
  $('#initialEase').value = state.prefs.initialEase || DEFAULTS.initialEase;
  $('#minEase').value = state.prefs.minEase || DEFAULTS.minEase;
  $('#dailyCap').value = state.prefs.dailyCap || DEFAULTS.dailyCap;
  renderAccentPicker();
}

/* ---------- Init ---------- */
async function init(){
  loadPrefs();
  // restore last language if set
  const last = localStorage.getItem('pp_last_lang_v2');
  if(last) state.lang = last;
  await loadData();
  wire();
  restoreLangUI();
  renderList();
  // dashboard restore
  try { const d = JSON.parse(localStorage.getItem('pp_dashboard_v2')||'{}'); state.dashboard = Object.assign(state.dashboard, d||{}); $('#streakBadge').textContent = `Streak: ${state.dashboard.streak||0}`; } catch(e){}
}
init();
</script>
</body>
</html>
