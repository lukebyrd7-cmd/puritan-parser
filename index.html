<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Puritan Parser</title>
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<style>
/* ---------------------------
   Theme variables (defaults)
   --------------------------- */
:root{
  --bg: #ffffff;
  --card: #fbfdfb;
  --muted: #6b7280;
  --text: #0f1720;
  --accent: #4e8f6e; /* neutral green default */
  --border: rgba(0,0,0,0.06);
  --radius: 12px;
  --shadow: 0 8px 24px rgba(15,23,32,0.06);
  --success: #15803d;
  --warn: #d97706;
  --danger: #b91c1c;
  --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --font-size: 16px;
  --reduced-motion: 0;
}
.light { /* explicit light */
  --bg:#ffffff; --card:#fbfdfb; --text:#0f1720; --muted:#6b7280;
}
.dark {
  --bg:#071226; --card:#071827; --text:#e6eef2; --muted:#94a3b8; --border: rgba(255,255,255,0.04);
}
body{
  margin:0; font-family:var(--font-sans); background:var(--bg); color:var(--text);
  -webkit-font-smoothing:antialiased; font-size:var(--font-size);
  transition: background 220ms ease, color 220ms ease;
  -webkit-tap-highlight-color: transparent;
}
.app{
  max-width:1080px; margin:18px auto; padding:14px;
}

/* header */
.header{
  display:flex; gap:12px; align-items:center; margin-bottom:14px;
}
.logo{
  width:56px; height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
  border:1px solid var(--border); box-shadow:var(--shadow);
  flex:0 0 56px;
}
.app-title{font-weight:700;font-size:18px;margin:0}
.subtitle{font-size:13px;color:var(--muted); margin-top:4px}

/* nav / top controls */
.topbar{display:flex; gap:12px; align-items:center; margin-bottom:14px; flex-wrap:wrap}
.lang-toggle{display:flex; gap:8px}
.lang-btn{padding:8px 10px;border-radius:10px;border:1px solid transparent;background:transparent;cursor:pointer}
.lang-btn.active{background:var(--accent); color:#fff; border-color:var(--border)}
.badge{background:var(--card); border:1px solid var(--border); padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}

/* layout */
.grid{display:grid; grid-template-columns:1fr 360px; gap:14px}
.panel{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--border)}
@media (max-width:900px){ .grid{grid-template-columns:1fr; } .panel{padding:10px} }

/* controls row */
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.input, select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
.slider-row{display:flex; gap:8px; align-items:center}
.range{width:160px}

/* table */
table{width:100%; border-collapse:collapse; font-size:14px}
th,td{padding:8px;border-bottom:1px solid var(--border); text-align:left}
th{font-weight:700;color:var(--muted); font-size:13px}

/* flashcard */
.flashcard{
  display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:220px;
}
.card-word{font-size:34px;font-weight:800;margin-bottom:6px; text-align:center}
.card-meta{font-size:13px;color:var(--muted); text-align:center; white-space:pre-wrap}
.card-actions{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; justify-content:center}
.btn{background:var(--accent); color:white; padding:8px 12px; border-radius:10px; border:none; cursor:pointer}
.btn.ghost{background:transparent; color:var(--accent); border:1px solid var(--border)}
.small{padding:6px 8px; font-size:13px}

/* rating buttons row */
.rating-row{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
.rating-btn{padding:8px 12px; border-radius:8px; border:1px solid var(--border); cursor:pointer; background:transparent}

/* quiz / parsing */
.quiz-choices{display:flex; flex-direction:column; gap:10px}
.choice{padding:10px;border-radius:8px;border:1px solid var(--border); background:transparent; cursor:pointer; text-align:left}

/* settings */
.settings-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
@media (max-width:700px){ .settings-grid{grid-template-columns:1fr} }

/* small utilities */
.muted{color:var(--muted); font-size:13px}
.tag{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.03);border:1px solid var(--border); font-size:12px;color:var(--muted)}

/* mastery pill */
.mastery{padding:6px 8px;border-radius:8px;color:white;font-weight:700;font-size:12px}
.mastery.low{background:var(--danger)}
.mastery.mid{background:var(--warn)}
.mastery.high{background:var(--success)}

/* focus & accessibility */
button:focus, input:focus, select:focus { outline:3px solid rgba(78,143,110,0.16); outline-offset:2px }
[role="dialog"]{max-width:860px}

/* animations - respect reduced motion */
@media (prefers-reduced-motion: reduce){
  :root{ --reduced-motion:1 }
}
.fade{transition:opacity 180ms ease}
.hidden{display:none}
</style>
   
   <!-- PWA / Home Screen Icons -->
<!-- Home Screen Icon (iOS uses this) -->
<link rel="apple-touch-icon" href="logo.png">

<!-- Optional favicon -->
<link rel="icon" href="logo.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Puritan Parser">
<meta name="theme-color" content="#4e8f6e">
   
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Puritan Parser">
<meta name="theme-color" content="#4e8f6e">

<link rel="manifest" href="manifest.json">  
   
</head>
<body>
<div class="app" id="app">
  <header class="header" role="banner">
    <div class="logo" id="logoWrap">
      <img id="logoImg" src="./logo.png" alt="The Puritan Parser logo" style="width:42px;height:42px;border-radius:8px" onerror="(function(){const s=document.createElement('div');s.innerHTML=svgFallback;const parent=document.getElementById('logoWrap');parent.innerHTML='';parent.appendChild(s.firstChild);})();">
    </div>
    <div>
      <div class="app-title">The Puritan Parser</div>
      <div class="subtitle">Biblical Greek (GNT) & Biblical Hebrew — Spaced Repetition & Parsing Practice</div>
    </div>
  </header>

  <div class="topbar" role="navigation" aria-label="Top controls">
    <div class="lang-toggle" role="tablist" aria-label="Language selector">
      <button class="lang-btn" data-lang="greek" id="btnGreek">Greek (GNT)</button>
      <button class="lang-btn" data-lang="hebrew" id="btnHebrew">Hebrew</button>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div class="badge" id="dueBadge">Due: 0</div>
      <div class="badge" id="streakBadge">Streak: 0</div>
      <button class="btn ghost small" id="openDashboard">Dashboard</button>
      <button class="btn ghost small" id="openParsing">Parsing</button>
      <button class="btn small" id="openFlash">Flashcards</button>
      <button class="btn ghost small" id="openSettings">Settings</button>
    </div>
  </div>

  <div class="grid">
    <!-- Main column -->
    <main class="panel" id="mainPanel" aria-live="polite">
      <!-- Mode header -->
      <div id="modeHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="tag" id="langTag">Greek</div>
            <div class="muted" id="entriesCount">0 entries</div>
            <div class="muted" id="dueInfo"></div>
          </div>
        </div>
        <div class="controls" style="gap:8px">
          <div>
            <input class="input" id="searchInput" placeholder="Search (word / lemma / gloss / pos)" />
          </div>
          <div style="display:flex;flex-direction:column">
            <label class="muted" style="font-size:12px">Min freq</label>
            <div class="slider-row">
              <input id="freqSlider" class="range" type="range" min="1" max="50" value="1" />
              <div class="muted" id="freqLabel">1+</div>
            </div>
          </div>
          <div>
            <select id="sortSelect" class="input">
              <option value="freq-desc">freq ↓</option>
              <option value="freq-asc">freq ↑</option>
              <option value="word-az">word A→Z</option>
              <option value="word-za">word Z→A</option>
            </select>
          </div>
        </div>
      </div>

      <!-- List view -->
      <section id="listView">
        <table id="wordsTable" aria-describedby="entriesCount">
          <thead><tr><th>word</th><th>lemma</th><th>gloss</th><th>pos</th><th>freq</th><th>due</th><th>ease</th><th>mastery</th></tr></thead>
          <tbody id="wordsTbody"></tbody>
        </table>
      </section>

      <!-- Flash view -->
      <section id="flashView" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="muted" id="flashProgress">0 / 0</div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">Study mode</label>
            <select id="studyMode" class="input">
              <option value="due">Due only</option>
              <option value="all">All filtered</option>
            </select>
            <label class="muted">Show gloss on front</label>
            <input type="checkbox" id="showGlossFront" />
          </div>
        </div>
        <div class="flashcard panel" id="cardWrap" style="min-height:260px">
          <div class="card-word" id="cardWord">—</div>
          <div class="card-meta" id="cardMeta">pos • freq • due</div>
          <div style="margin-top:12px">
            <button class="btn ghost small" id="revealBtn">Reveal</button>
            <button class="btn small" id="againBtn">Again</button>
          </div>
          <div style="margin-top:12px" class="rating-row" id="ratingRow">
            <!-- rating buttons 0-5 -->
          </div>
        </div>
      </section>

      <!-- Parsing view -->
      <section id="parsingView" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">Mode</label>
            <select id="parsingMode" class="input">
              <option value="nouns">Nouns</option>
              <option value="verbs">Verbs</option>
              <option value="mixed">Mixed</option>
            </select>
            <label class="muted">Count</label>
            <input id="parsingCount" type="number" class="input" value="10" min="5" max="200" style="width:86px" />
          </div>
          <div>
            <button class="btn small" id="startParsing">Start</button>
          </div>
        </div>
        <div id="parsingWrap" class="panel" style="min-height:200px">
          <div id="parsingQuestion" style="font-weight:700;font-size:18px;margin-bottom:8px">Press Start</div>
          <div id="parsingForm"></div>
          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
            <div class="muted" id="parsingProgress">0 / 0</div>
            <div>
              <button class="btn ghost small" id="nextParsing">Next</button>
              <button class="btn ghost small" id="endParsing">End</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Dashboard view -->
      <section id="dashboardView" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div style="font-weight:700">Study Dashboard</div>
            <div class="muted">Quick summary and recommended session</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Due today</div>
            <div style="font-size:20px;font-weight:800" id="dashDue">0</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="panel">
            <div style="font-weight:700">Recent Performance</div>
            <canvas id="perfSpark" width="400" height="80" style="width:100%;height:60px"></canvas>
          </div>
          <div class="panel">
            <div style="font-weight:700">Stats</div>
            <div style="margin-top:8px">
              <div>Avg ease: <span id="avgEase">—</span></div>
              <div>Reviews this week: <span id="revWeek">0</span></div>
              <div>Study streak: <span id="dashStreak">0</span></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Sidebar -->
    <aside class="panel" id="sidePanel">
      <div style="display:flex;flex-direction:column;gap:10px">
        <div>
          <label class="muted">Accent color</label>
          <div id="accentPicker" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="customAccent" class="input" placeholder="#rrggbb" />
            <button class="btn small" id="applyAccent">Apply</button>
          </div>
        </div>

        <div>
          <label class="muted">Theme</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost small theme-btn" data-theme="light">Light</button>
            <button class="btn ghost small theme-btn" data-theme="dark">Dark</button>
            <button class="btn ghost small theme-btn" data-theme="system">System</button>
          </div>
        </div>

        <div>
          <label class="muted">SRS Options</label>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <label class="muted"><input type="checkbox" id="useSM2" checked /> Use SM-2 algorithm</label>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="muted" style="width:120px">Initial ease</label>
              <input id="initialEase" class="input" type="number" step="0.1" value="2.5" style="width:86px" />
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="muted" style="width:120px">Min ease</label>
              <input id="minEase" class="input" type="number" step="0.1" value="1.3" style="width:86px" />
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="muted" style="width:120px">Daily cap</label>
              <input id="dailyCap" class="input" type="number" value="200" style="width:86px" />
            </div>
          </div>
        </div>

        <div>
          <label class="muted">Frequency filter</label>
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
            <input id="sidebarFreq" type="range" min="1" max="50" value="1" class="range" />
            <div class="muted" id="sidebarFreqLabel">1+</div>
          </div>
        </div>

        <div>
          <label class="muted">Actions</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn small" id="resetSRS">Reset SRS (current lang)</button>
            <button class="btn ghost small" id="clearAll">Clear all local data</button>
          </div>
        </div>

        <div>
          <label class="muted">Help</label>
          <div class="muted" style="margin-top:8px">First time? The app will initialize SRS fields automatically. Use Flashcards to review due items. Parsing Practice contains noun/verb drills.</div>
        </div>
      </div>
    </aside>
  </div>

  <footer style="margin-top:14px;color:var(--muted);font-size:13px">The Puritan Parser — local-only data. Service worker available for offline.</footer>
</div>

<!-- Inline SVG fallback used by logo onerror -->
<script>
const svgFallback = `<?xml version="1.0" encoding="UTF-8"?> 
<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 64 64" role="img" aria-label="Puritan Parser">
  <rect width="64" height="64" rx="12" fill="#4e8f6e"/>
  <text x="50%" y="54%" font-size="26" text-anchor="middle" fill="#fff" font-family="serif" font-weight="700">PP</text>
</svg>`;
</script>

<script>
/* =========================
   App: Data + SRS + UI
   ========================= */

/* ---------- Constants & Keys ---------- */
const FILE_ALL = 'vocab_all.json';
const FILE_GREEK = 'greek_25plus.json';
const FILE_HEBREW = 'hebrew_60plus.json';
const LS_VOCAB_GREEK = 'pp_vocab_greek';
const LS_VOCAB_HEBREW = 'pp_vocab_hebrew';
const LS_PREFS = 'pp_prefs';
const LS_PROGRESS = 'pp_progress';

const DEFAULTS = {
  accent: '#4e8f6e',
  theme: 'light',
  initialEase: 2.5,
  minEase: 1.3,
  useSM2: true,
  dailyCap: 200,
  freqMin: 1
};

/* ---------- State ---------- */
let state = {
  lang: 'greek',
  data: { greek: [], hebrew: [] },
  filtered: [],
  prefs: {},
  session: { queue: [], idx: 0, mode: 'due', showGlossFront:false },
  dashboard: { streak: 0, recent: [] }
};

/* ---------- Utilities ---------- */
function todayISO(offsetDays=0){
  const d = new Date();
  d.setDate(d.getDate() + offsetDays);
  return d.toISOString().slice(0,10);
}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function uid(len=10){ return Math.random().toString(36).slice(2,2+len); }

/**
 * daysBetween - robustly accept Date or ISO string
 * returns (a - b) in whole days (can be negative)
 */
function daysBetween(aIso, bIso){
  const toDate = x => (x instanceof Date) ? new Date(Date.UTC(x.getFullYear(), x.getMonth(), x.getDate())) : new Date(x + 'T00:00:00Z');
  const a = toDate(aIso);
  const b = toDate(bIso);
  const diff = (a - b) / (1000*60*60*24);
  return Math.round(diff);
}

/* ---------- Storage ---------- */
function loadPrefs(){
  try {
    const raw = localStorage.getItem(LS_PREFS);
    state.prefs = raw ? JSON.parse(raw) : {...DEFAULTS};
    // ensure defaults
    state.prefs = Object.assign({}, DEFAULTS, state.prefs || {});
    applyTheme(state.prefs.theme || DEFAULTS.theme);
    setAccent(state.prefs.accent || DEFAULTS.accent);
  } catch(e){ state.prefs = {...DEFAULTS}; }
}
function savePrefs(){ localStorage.setItem(LS_PREFS, JSON.stringify(state.prefs)); }

function saveVocab(lang){
  try { localStorage.setItem(lang==='greek'?LS_VOCAB_GREEK:LS_VOCAB_HEBREW, JSON.stringify(state.data[lang])); }
  catch(e){ console.warn('save failed', e); }
}
function persistAll(){
  saveVocab('greek'); saveVocab('hebrew'); savePrefs();
}

/* ---------- SRS: SM-2 Implementation ---------- */
/*
  Word object shape (ensured):
  { id, lang, word, lemma, gloss, pos, freq,
    ease, interval, repetitions, due, history: [{date,q}] }
*/
function ensureSRS(item){
  if(typeof item.ease !== 'number') item.ease = Number(state.prefs.initialEase || DEFAULTS.initialEase) || 2.5;
  if(typeof item.interval !== 'number') item.interval = 0;
  if(typeof item.repetitions !== 'number') item.repetitions = 0;
  if(!item.due) item.due = todayISO();
  if(!Array.isArray(item.history)) item.history = [];
  // id
  if(!item.id) item.id = `${item.lang}-${uid(8)}-${Math.abs((item.word||'').length)}`;
  return item;
}

/* SM-2: quality scale 0-5 input */
function sm2Update(item, quality){
  // quality: 0..5 (5 perfect)
  // follow SM-2 algorithm
  if(!item) return;
  item.history = item.history || [];
  item.history.push({date: todayISO(), q: quality});
  if(quality < 3){
    item.repetitions = 0;
    item.interval = 1;
  } else {
    item.repetitions = (item.repetitions || 0) + 1;
    if(item.repetitions === 1) item.interval = 1;
    else if(item.repetitions === 2) item.interval = 6;
    else item.interval = Math.round((item.interval || 1) * (item.ease || 2.5));
  }
  // update ease
  item.ease = (item.ease || state.prefs.initialEase || 2.5) + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
  item.ease = clamp(item.ease, state.prefs.minEase || DEFAULTS.minEase, 10);
  // set next due
  const next = new Date();
  next.setDate(next.getDate() + (item.interval || 1));
  item.due = next.toISOString().slice(0,10);
  return item;
}

/* Fallback Leitner-style simple scheduler */
function leitnerUpdate(item, quality){
  // quality 0-5: treat >=3 as success, else fail
  const success = quality >= 3;
  if(success){
    item.repetitions = (item.repetitions || 0) + 1;
    item.interval = Math.min(365, Math.max(1, Math.round((item.repetitions || 1) * 2)));
  } else {
    item.repetitions = 0;
    item.interval = 1;
  }
  const next = new Date(); next.setDate(next.getDate() + (item.interval||1));
  item.due = next.toISOString().slice(0,10);
  return item;
}

/* Wrapper: update by quality using chosen algorithm */
function scheduleUpdate(item, quality){
  if(state.prefs.useSM2) return sm2Update(item, quality);
  return leitnerUpdate(item, quality);
}

/* ---------- Data Loading ---------- */
/* Try vocab_all.json first, else per-language files, else fallback samples */
async function tryFetchJson(path){
  try {
    const r = await fetch(path, {cache:'no-store'});
    if(!r.ok) throw new Error('not ok');
    const j = await r.json();
    if(!Array.isArray(j)) throw new Error('not array');
    return j;
  } catch(e){ return null; }
}

async function loadData(){
  // attempt all-in-one
  const all = await tryFetchJson(FILE_ALL);
  if(all && all.length){
    // split
    const g = all.filter(x => (x.lang||'greek').toLowerCase() === 'greek');
    const h = all.filter(x => (x.lang||'hebrew').toLowerCase() === 'hebrew');
    state.data.greek = g.map(it => { it.lang='greek'; return ensureSRS(it); });
    state.data.hebrew = h.map(it => { it.lang='hebrew'; return ensureSRS(it); });
    saveVocab('greek'); saveVocab('hebrew');
    renderAll();
    return;
  }
  // try per-language files
  const gfile = await tryFetchJson(FILE_GREEK);
  const hfile = await tryFetchJson(FILE_HEBREW);
  if(gfile && gfile.length){ state.data.greek = gfile.map(it=>{ it.lang='greek'; return ensureSRS(it); }); saveVocab('greek'); }
  else {
    // try localStorage
    try {
      const raw = localStorage.getItem(LS_VOCAB_GREEK);
      state.data.greek = raw ? JSON.parse(raw) : SAMPLE_GREEK.map(it=>ensureSRS(Object.assign({lang:'greek'}, it)));
    } catch(e){ state.data.greek = SAMPLE_GREEK.map(it=>ensureSRS(Object.assign({lang:'greek'}, it))); }
  }
  if(hfile && hfile.length){ state.data.hebrew = hfile.map(it=>{ it.lang='hebrew'; return ensureSRS(it); }); saveVocab('hebrew'); }
  else {
    try {
      const raw = localStorage.getItem(LS_VOCAB_HEBREW);
      state.data.hebrew = raw ? JSON.parse(raw) : SAMPLE_HEBREW.map(it=>ensureSRS(Object.assign({lang:'hebrew'}, it)));
    } catch(e){ state.data.hebrew = SAMPLE_HEBREW.map(it=>ensureSRS(Object.assign({lang:'hebrew'}, it))); }
  }
  renderAll();
}

/* ---------- Rendering: Accent & Theme ---------- */
function setAccent(hex){
  document.documentElement.style.setProperty('--accent', hex);
  state.prefs.accent = hex;
  savePrefs();
  // re-render accent buttons selection
  renderAccentButtons();
}
function applyTheme(theme){
  state.prefs.theme = theme || 'system';
  savePrefs();
  document.documentElement.classList.remove('dark','light');
  if(theme === 'dark'){ document.documentElement.classList.add('dark'); }
  else if(theme === 'light'){ document.documentElement.classList.add('light'); }
  else {
    // system
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    else document.documentElement.classList.add('light');
  }
  // mark active
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === theme));
}

/* Accent button rendering */
const ACCENTS = ['#4e8f6e','#246b9c','#2a9d8f','#8a2b2b','#d97706','#475569','#6b21a8','#b91c1c','#0ea5a4','#ef4444','#f97316','#06b6d4'];
function renderAccentButtons(){
  const el = document.getElementById('accentPicker');
  if(!el) return;
  el.innerHTML = '';
  ACCENTS.forEach(hex=>{
    const b = document.createElement('button');
    b.className='color-btn';
    b.style.width='32px'; b.style.height='32px'; b.style.borderRadius='8px';
    b.style.border='2px solid transparent'; b.style.cursor='pointer';
    b.style.background=hex;
    b.title = hex;
    b.addEventListener('click', ()=> setAccent(hex));
    el.appendChild(b);
  });
}

/* ---------- UI wiring & behavior ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/**
 * setLang - sets UI language but DOES NOT change document direction.
 * Hebrew remains displayed LTR (no mirroring).
 */
function setLang(lang){
  state.lang = lang;
  // set active button - ensure both language buttons are toggled
  $$('#btnGreek,#btnHebrew').forEach(b => {
    const btnLang = (b.dataset && b.dataset.lang) ? b.dataset.lang : (b.id === 'btnGreek' ? 'greek' : (b.id === 'btnHebrew' ? 'hebrew' : ''));
    b.classList.toggle('active', btnLang === lang);
  });
  $('#langTag').textContent = lang === 'greek' ? 'Greek' : 'Hebrew';
  $('#langTag').setAttribute('aria-label', `${lang === 'greek' ? 'Greek' : 'Hebrew'} section`);
  // IMPORTANT: Do NOT change document.documentElement.dir
  renderList();
  saveLastLang();
}

function saveLastLang(){ localStorage.setItem('pp_last_lang', state.lang); }
function loadLastLang(){ const last = localStorage.getItem('pp_last_lang'); if(last) state.lang = last; }

/* Filtering & rendering list */
function getCurrentList(){ return state.data[state.lang] || []; }

function computeMastery(item){
  const reps = item.repetitions || 0;
  const ease = item.ease || state.prefs.initialEase || 2.5;
  const last = item.history && item.history.length ? item.history[item.history.length-1].date : item.due;
  // compute days between today and last
  let days = 0;
  try { days = Math.max(0, daysBetween(todayISO(), last || todayISO())); } catch(e){ days = 0; }
  const raw = (reps * ease) / (1 + days/30);
  const score = Math.round(clamp(raw/ ( (state.prefs.initialEase||2.5) ) * 100, 0, 100));
  return score;
}

function renderList(){
  const q = ($('#searchInput') && $('#searchInput').value) ? ($('#searchInput').value || '').toLowerCase().trim() : '';
  const minFreq = Number($('#freqSlider').value) || 1;
  const sort = $('#sortSelect').value;
  let list = getCurrentList().filter(it => {
    if(!it) return false;
    const freqOk = (Number(it.freq || 0) >= minFreq);
    if(!q) return freqOk;
    const combined = `${it.word||''} ${it.lemma||''} ${it.gloss||''} ${it.pos||''}`.toLowerCase();
    return freqOk && combined.includes(q);
  });

  list.sort((a,b)=>{
    if(sort==='freq-desc') return (b.freq||0)-(a.freq||0);
    if(sort==='freq-asc') return (a.freq||0)-(b.freq||0);
    if(sort==='word-az') return String(a.word||'').localeCompare(String(b.word||''));
    if(sort==='word-za') return String(b.word||'').localeCompare(String(a.word||''));
    return 0;
  });

  state.filtered = list;
  const entriesCountEl = $('#entriesCount');
  if(entriesCountEl) entriesCountEl.textContent = `${list.length} entries`;
  // due counts
  const dueCount = list.filter(it => it.due && it.due <= todayISO()).length;
  const dueBadgeEl = $('#dueBadge'); if(dueBadgeEl) dueBadgeEl.textContent = `Due: ${dueCount}`;
  const dashDueEl = $('#dashDue'); if(dashDueEl) dashDueEl.textContent = dueCount;

  // render rows
  const tbody = $('#wordsTbody'); if(!tbody) return;
  tbody.innerHTML = '';
  if(!list.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="8" class="muted">No entries found. Reduce min frequency or switch language.</td>`;
    tbody.appendChild(tr);
    return;
  }
  for(const it of list){
    const tr = document.createElement('tr');
    const mastery = computeMastery(it);
    let cls = 'mastery.low'; if(mastery>60) cls='mastery.high'; else if(mastery>25) cls='mastery.mid';
    const easeDisplay = (typeof it.ease === 'number') ? (it.ease).toFixed(2) : (it.ease || '—');
    tr.innerHTML = `<td>${escapeHtml(it.word||'')}</td>
                    <td>${escapeHtml(it.lemma||'')}</td>
                    <td>${escapeHtml(it.gloss||'')}</td>
                    <td>${escapeHtml(it.pos||'')}</td>
                    <td>${escapeHtml(String(it.freq||0))}</td>
                    <td>${escapeHtml(it.due||'—')}</td>
                    <td>${escapeHtml(easeDisplay)}</td>
                    <td><span class="mastery ${cls.replace('mastery.','')}" style="display:inline-block;padding:4px 8px">${mastery}</span></td>`;
    tbody.appendChild(tr);
  }
}

/* Simple escaping */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Flashcard Session ---------- */
function startFlash(){
  // build queue
  const studyModeEl = $('#studyMode');
  const mode = studyModeEl ? studyModeEl.value : 'due';
  const minFreq = Number($('#freqSlider').value) || 1;
  let pool = getCurrentList().filter(it => (it.freq||0) >= minFreq);
  if(mode === 'due') pool = pool.filter(it => it.due && it.due <= todayISO());
  if(!pool.length){ alert('No cards available for this session. Try "All filtered" or reduce min frequency.'); return; }
  // shuffle and cap daily
  pool = shuffle(pool);
  const cap = Number(state.prefs.dailyCap || 200) || 200;
  state.session.queue = pool.slice(0, cap);
  state.session.idx = 0;
  state.session.mode = mode;
  state.session.showGlossFront = !!$('#showGlossFront').checked;
  // show flash view and render first card
  showView('flash');
  renderFlashCard();
}
function renderFlashCard(){
  const q = state.session.queue || [];
  const idx = Math.max(0, state.session.idx || 0);
  if(!$('#flashProgress')){} else {
    $('#flashProgress').textContent = (q.length ? `${idx+1} / ${q.length}` : `0 / 0`);
  }
  if(!q.length){
    $('#cardWord').textContent = '—';
    $('#cardMeta').textContent='No cards';
    const rrEmpty = $('#ratingRow'); if(rrEmpty) rrEmpty.innerHTML = '';
    return;
  }
  const cur = q[idx];
  if(!cur){
    $('#cardWord').textContent = '—';
    $('#cardMeta').textContent='No current card';
    return;
  }
  $('#cardWord').textContent = cur.word || '—';
  const metaParts = [`${cur.pos||'—'}`, `freq ${cur.freq||0}`, `due ${cur.due||'—'}`];
  $('#cardMeta').textContent = state.session.showGlossFront ? `${metaParts.join(' • ')}\n${cur.gloss||''}` : metaParts.join(' • ');
  $('#revealBtn').textContent = 'Reveal';
  // render rating buttons 0..5
  const rr = $('#ratingRow'); rr.innerHTML = '';
  for(let i=0;i<=5;i++){
    const b = document.createElement('button');
    b.className = 'rating-btn';
    b.textContent = i===0? '0 (Forgot)' : i;
    b.title = `Quality ${i}`;
    b.addEventListener('click', ()=> onRate(i));
    rr.appendChild(b);
  }
}
function onReveal(){
  const cur = state.session.queue[state.session.idx];
  if(!cur) return;
  $('#cardMeta').textContent = `${cur.lemma||'—'} • ${cur.pos||'—'} • freq ${cur.freq||0}\nGloss: ${cur.gloss||''}\nNext due: ${cur.due||'—'} • interval ${cur.interval||0}d`;
  $('#revealBtn').textContent = 'Hide';
}
function onAgain(){
  const idx = state.session.idx;
  const q = state.session.queue;
  if(!Array.isArray(q) || q.length === 0) return;
  const cur = q.splice(idx,1)[0];
  q.push(cur);
  if(idx >= q.length) state.session.idx = Math.max(0, q.length-1);
  renderFlashCard();
}
function onRate(quality){
  const q = state.session.queue || [];
  const idx = state.session.idx || 0;
  const cur = q[idx];
  if(!cur) return;
  // record rating
  if(state.prefs.useSM2) sm2Update(cur, quality);
  else leitnerUpdate(cur, quality);
  // persist
  saveVocab(cur.lang);
  // remove from session queue
  state.session.queue.splice(idx,1);
  // adjust idx
  if(state.session.idx >= state.session.queue.length) state.session.idx = Math.max(0, state.session.queue.length-1);
  // stats & dashboard
  recordReview(quality);
  // if done
  if(!state.session.queue.length){ alert('Session complete'); showView('list'); renderList(); return; }
  renderFlashCard();
}

/* Session tracking and simple streak */
function recordReview(quality){
  const recent = state.dashboard.recent || [];
  recent.push({date:todayISO(), q: Number(quality)});
  // keep 60 days
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 60);
  state.dashboard.recent = recent.filter(r => new Date(r.date) >= cutoff);
  // simple streak: increment if last day had review
  const lastDates = Array.from(new Set(state.dashboard.recent.map(r=>r.date))).sort();
  // compute streak
  let streak=0; let d=new Date();
  for(let i=0;i<365;i++){
    const iso = d.toISOString().slice(0,10);
    if(lastDates.includes(iso)) { streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  state.dashboard.streak = streak;
  localStorage.setItem('pp_dashboard', JSON.stringify(state.dashboard));
  const sb = $('#streakBadge'); if(sb) sb.textContent = `Streak: ${state.dashboard.streak}`;
  const ds = $('#dashStreak'); if(ds) ds.textContent = state.dashboard.streak;
}

/* ---------- Parsing Practice ---------- */
let parsingSession = { questions: [], idx: 0, correct:0, total:0 };

function startParsing(){
  const mode = $('#parsingMode') ? $('#parsingMode').value : 'mixed';
  const count = Number($('#parsingCount').value) || 10;
  const minFreq = Number($('#freqSlider').value) || 1;
  let pool = getCurrentList().filter(it => (it.freq||0) >= minFreq);
  if(mode === 'nouns') pool = pool.filter(it => (it.pos||'').toLowerCase().includes('n'));
  if(mode === 'verbs') pool = pool.filter(it => (it.pos||'').toLowerCase().includes('v'));
  if(!pool.length){ alert('No items for parsing with current filters.'); return; }
  pool = shuffle(pool).slice(0, Math.min(count, pool.length));
  parsingSession.questions = pool;
  parsingSession.idx = 0; parsingSession.correct = 0; parsingSession.total = pool.length;
  showView('parsing');
  renderParsingQuestion();
}

function renderParsingQuestion(){
  const qWrap = $('#parsingWrap');
  const idx = parsingSession.idx;
  const qn = parsingSession.questions[idx];
  if(!qn){
    $('#parsingQuestion').textContent = 'Finished'; 
    $('#parsingForm').innerHTML = '';
    $('#parsingProgress').textContent = `0 / 0`;
    return;
  }
  $('#parsingQuestion').textContent = `Parse: ${qn.word}`;
  // build form
  const form = $('#parsingForm'); if(!form) return;
  form.innerHTML = '';
  const fields = [];
  // if parse field exists, parse it (assume compact like "N-NSM" or "V-PAI-3S")
  if(qn.parse){
    if(qn.parse.startsWith('N-') || (qn.pos||'').toLowerCase().includes('n')){
      // noun: case, number, gender, lemma
      fields.push({id:'case', label:'Case', type:'select', opts:['nom','acc','gen','dat','voc']});
      fields.push({id:'number', label:'Number', type:'select', opts:['sg','pl']});
      fields.push({id:'gender', label:'Gender', type:'select', opts:['m','f','n']});
      fields.push({id:'lemma', label:'Lemma', type:'text'});
    } else {
      // verb: tense, voice, mood, personNumber, lemma
      fields.push({id:'tense', label:'Tense', type:'select', opts:['pres','impf','fut','aor','perf','plup']});
      fields.push({id:'mood', label:'Mood', type:'select', opts:['ind','subj','opt','imp']});
      fields.push({id:'voice', label:'Voice', type:'select', opts:['act','mid','pas']});
      fields.push({id:'person', label:'Person/Number', type:'select', opts:['1s','2s','3s','1p','2p','3p']});
      fields.push({id:'lemma', label:'Lemma', type:'text'});
    }
  } else {
    // fallback: ask multiple choice lemma or gloss
    fields.push({id:'lemma', label:'Lemma (type)', type:'text'});
  }

  for(const f of fields){
    const row = document.createElement('div'); row.style.marginBottom='8px';
    const label = document.createElement('label'); label.className='muted'; label.textContent = f.label; row.appendChild(label);
    if(f.type === 'select'){
      const s = document.createElement('select'); s.className='input'; s.id = 'par_'+f.id;
      f.opts.forEach(o => { const opt = document.createElement('option'); opt.value=o; opt.textContent=o; s.appendChild(opt); });
      row.appendChild(s);
    } else {
      const inp = document.createElement('input'); inp.type='text'; inp.className='input'; inp.id='par_'+f.id;
      row.appendChild(inp);
    }
    form.appendChild(row);
  }
  // add submit button
  const submit = document.createElement('button'); submit.className='btn small'; submit.textContent='Submit';
  submit.addEventListener('click', (e)=>{ e.preventDefault(); checkParsingAnswer(qn); });
  form.appendChild(submit);
  $('#parsingProgress').textContent = `${idx+1} / ${parsingSession.total}`;
}

function checkParsingAnswer(qn){
  // naive checking: if parse present, do simple substring checks
  let correct = 0; let total = 0; const feedback = [];
  if(qn.parse){
    // split parse by '-' and map heuristics
    const p = (qn.parse || '').toLowerCase();
    // noun checks
    if((qn.pos||'').toLowerCase().includes('n') || p.startsWith('n-')){
      const cas = $('#par_case') ? $('#par_case').value : '';
      const num = $('#par_number') ? $('#par_number').value : '';
      const gen = $('#par_gender') ? $('#par_gender').value : '';
      const lemma = $('#par_lemma') ? ($('#par_lemma').value||'').trim() : '';
      total += 4;
      if(p.includes(cas)) correct++; else feedback.push(`Case expected part of "${p}"`);
      if(p.includes(num)) correct++; else feedback.push(`Number expected part of "${p}"`);
      if(p.includes(gen)) correct++; else feedback.push(`Gender expected part of "${p}"`);
      if((qn.lemma||'').toLowerCase() === lemma.toLowerCase()) { correct++; } else feedback.push(`Lemma expected "${qn.lemma}"`);
    } else {
      // verb
      const tense = $('#par_tense')?$('#par_tense').value:'';
      const mood = $('#par_mood')?$('#par_mood').value:'';
      const voice = $('#par_voice')?$('#par_voice').value:'';
      const person = $('#par_person')?$('#par_person').value:'';
      const lemma = $('#par_lemma')?($('#par_lemma').value||'').trim():'';
      total += 5;
      if(p.includes(tense)) correct++; else feedback.push(`Tense expected part of "${p}"`);
      if(p.includes(mood)) correct++; else feedback.push(`Mood expected part of "${p}"`);
      if(p.includes(voice)) correct++; else feedback.push(`Voice expected part of "${p}"`);
      if(p.includes(person)) correct++; else feedback.push(`Person/Number expected part of "${p}"`);
      if((qn.lemma||'').toLowerCase() === lemma.toLowerCase()) { correct++; } else feedback.push(`Lemma expected "${qn.lemma}"`);
    }
  } else {
    // fallback: lemma only
    total = 1;
    const lemma = $('#par_lemma')?($('#par_lemma').value||'').trim():'';
    if((qn.lemma||'').toLowerCase() === lemma.toLowerCase()){ correct = 1; } else feedback.push(`Lemma expected "${qn.lemma}"`);
  }
  // update stats
  parsingSession.idx++;
  if(correct === total) parsingSession.correct++;
  // show feedback
  alert(`You got ${correct}/${total}.\n${feedback.join('\n')}`);
  if(parsingSession.idx >= parsingSession.total){ alert(`Parsing session complete — score ${parsingSession.correct}/${parsingSession.total}`); showView('list'); return; }
  renderParsingQuestion();
}

/* ---------- Dashboard rendering (sparkline) ---------- */
function renderDashboard(){
  const recent = state.dashboard.recent || [];
  const revWeek = $('#revWeek'); if(revWeek) revWeek.textContent = (recent && recent.length) || 0;
  const avgEaseEl = $('#avgEase');
  const avg = computeAvgEase();
  if(avgEaseEl) avgEaseEl.textContent = (typeof avg === 'number' ? avg.toFixed(2) : '—');
  const sb = $('#streakBadge'); if(sb) sb.textContent = `Streak: ${state.dashboard.streak||0}`;
  // sparkline: use canvas with recent q values
  const canvas = $('#perfSpark'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!recent.length) return;
  const arr = recent.slice(-30).map(r => r.q);
  const w = canvas.width, h = canvas.height;
  const maxQ = 5, minQ = 0;
  ctx.beginPath();
  const firstY = h - ((arr[0]-minQ)/(maxQ-minQ))*h;
  ctx.moveTo(0, firstY);
  arr.forEach((v,i)=>{
    const x = (i/(arr.length-1 || 1)) * w;
    const y = h - ((v-minQ)/(maxQ-minQ))*h;
    ctx.lineTo(x,y);
  });
  ctx.strokeStyle = state.prefs.accent || '#4e8f6e'; ctx.lineWidth = 2; ctx.stroke();
}

function computeAvgEase(){
  const list = getCurrentList();
  if(!list.length) return 0;
  const sum = list.reduce((s,it)=>s + (Number(it.ease)||0), 0);
  return sum/list.length;
}

/* ---------- Helpers & View Controller ---------- */

/**
 * showView - accepts a shorthand ('list','flash','parsing','dashboard') or a full id ('listView', etc.)
 * Ensures only the requested view is visible. Also updates focus and runs any render hooks.
 */
function showView(request){
  const map = {
    list: 'listView',
    flash: 'flashView',
    parsing: 'parsingView',
    dashboard: 'dashboardView',
    listView: 'listView',
    flashView: 'flashView',
    parsingView: 'parsingView',
    dashboardView: 'dashboardView'
  };
  const targetId = map[request] || request;
  const allViews = ['listView','flashView','parsingView','dashboardView'];
  allViews.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    if(id === targetId) el.classList.remove('hidden');
    else el.classList.add('hidden');
  });
  // run view-specific hooks
  if(targetId === 'flashView'){
    const btn = $('#openFlash'); if(btn) btn.focus();
  } else if(targetId === 'parsingView'){
    const btn = $('#openParsing'); if(btn) btn.focus();
  } else if(targetId === 'dashboardView'){
    renderDashboard();
    const btn = $('#openDashboard'); if(btn) btn.focus();
  } else if(targetId === 'listView'){
    renderList();
    const el = $('#openDashboard'); if(el) el.blur();
  }
}

/* ---------- Misc UI events ---------- */
let eventsWired = false;
function wireEvents(){
  if(eventsWired) return;
  eventsWired = true;

  // language buttons
  $('#btnGreek').addEventListener('click', ()=> setLang('greek'));
  $('#btnHebrew').addEventListener('click', ()=> setLang('hebrew'));

  // search & controls
  const searchInput = $('#searchInput');
  if(searchInput) searchInput.addEventListener('input', debounce(()=> renderList(),150));

  const freqSlider = $('#freqSlider');
  if(freqSlider) freqSlider.addEventListener('input', ()=> {
    $('#freqLabel').textContent = (freqSlider.value >= 50) ? '50+' : freqSlider.value + '+';
    const sidebar = $('#sidebarFreq'); if(sidebar) sidebar.value = freqSlider.value;
    renderList();
  });
  const sidebarFreq = $('#sidebarFreq');
  if(sidebarFreq) sidebarFreq.addEventListener('input', ()=> {
    $('#sidebarFreqLabel').textContent = (sidebarFreq.value >= 50) ? '50+' : sidebarFreq.value + '+';
    const mainSlider = $('#freqSlider'); if(mainSlider) mainSlider.value = sidebarFreq.value;
    renderList();
  });

  const sortSelect = $('#sortSelect');
  if(sortSelect) sortSelect.addEventListener('change', ()=> renderList());

  // flash
  $('#openFlash').addEventListener('click', ()=> startFlash());
  const revealBtn = $('#revealBtn');
  if(revealBtn) revealBtn.addEventListener('click', ()=> {
    if($('#revealBtn').textContent === 'Reveal') onReveal();
    else { renderFlashCard(); }
  });
  const againBtn = $('#againBtn');
  if(againBtn) againBtn.addEventListener('click', onAgain);

  // parsing
  $('#openParsing').addEventListener('click', ()=> showView('parsing'));
  $('#startParsing').addEventListener('click', startParsing);
  $('#nextParsing').addEventListener('click', ()=> { parsingSession.idx++; renderParsingQuestion(); });
  $('#endParsing').addEventListener('click', ()=> showView('list'));

  // dashboard & settings
  $('#openDashboard').addEventListener('click', ()=> { showView('dashboard'); });
  $('#openSettings').addEventListener('click', ()=> { document.getElementById('sidePanel').scrollIntoView({behavior:'smooth'}); });

  // SRS controls
  const useSM2El = $('#useSM2');
  if(useSM2El) useSM2El.addEventListener('change', (e)=> { state.prefs.useSM2 = e.target.checked; savePrefs(); });
  const initialEaseEl = $('#initialEase');
  if(initialEaseEl) initialEaseEl.addEventListener('change', (e)=> { state.prefs.initialEase = Number(e.target.value)||2.5; savePrefs(); });
  const minEaseEl = $('#minEase');
  if(minEaseEl) minEaseEl.addEventListener('change', (e)=> { state.prefs.minEase = Number(e.target.value)||1.3; savePrefs(); });
  const dailyCapEl = $('#dailyCap');
  if(dailyCapEl) dailyCapEl.addEventListener('change', (e)=> { state.prefs.dailyCap = Number(e.target.value)||200; savePrefs(); });

  // accents
  $('#applyAccent').addEventListener('click', ()=> {
    const val = ($('#customAccent').value||'').trim();
    if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val)){ setAccent(val); } else alert('Enter valid hex #rrggbb');
  });

  // theme
  $$('.theme-btn').forEach(b => b.addEventListener('click', ()=> applyTheme(b.dataset.theme)));

  // reset SRS and clear data
  $('#resetSRS').addEventListener('click', ()=> {
    if(!confirm('Reset SRS for current language? This will set ease/interval/repetitions/due to defaults.')) return;
    const list = state.data[state.lang] || [];
    list.forEach(it => { it.ease = state.prefs.initialEase; it.interval = 0; it.repetitions = 0; it.due = todayISO(); it.history = []; });
    saveVocab(state.lang); renderList();
  });
  $('#clearAll').addEventListener('click', ()=> {
    if(!confirm('Clear all local data? This will reset vocab and progress.')) return;
    localStorage.removeItem(LS_VOCAB_GREEK); localStorage.removeItem(LS_VOCAB_HEBREW); localStorage.removeItem(LS_PREFS); location.reload();
  });

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'f' || e.key === 'F'){ e.preventDefault(); $('#openFlash').click(); }
    if(e.key === 'p' || e.key === 'P'){ e.preventDefault(); $('#openParsing').click(); }
    if(e.key === 'd' || e.key === 'D'){ e.preventDefault(); $('#openDashboard').click(); }
    if(e.key === 's' || e.key === 'S'){ e.preventDefault(); $('#openSettings').click(); }
    // rating keys during flash
    const flashViewEl = document.getElementById('flashView');
    if(flashViewEl && !flashViewEl.classList.contains('hidden')){
      const key = Number(e.key);
      if(!isNaN(key) && key >= 0 && key <= 5){ onRate(key); }
    }
  });

  // page visibility: save prefs periodically
  window.addEventListener('beforeunload', ()=> persistAll());

  // service worker registration (optional & safe)
  try {
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{/* ignore registration errors */});
    }
  } catch (e){}
}

/* ---------- Utilities ---------- */
function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5); }
function debounce(fn, wait=200){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), wait); }; }

/* ---------- Sample Data (fallback) ---------- */
const SAMPLE_GREEK = [
  {word:"λόγος",lemma:"λόγος",gloss:"word, message",pos:"noun",freq:330, parse:"N-NSM"},
  {word:"ἀγαπᾷ",lemma:"ἀγαπάω",gloss:"to love",pos:"verb",freq:120, parse:"V-PRES-ACT-3S"},
  {word:"θεός",lemma:"θεός",gloss:"God",pos:"noun",freq:1317, parse:"N-NSM"},
  {word:"πιστός",lemma:"πιστός",gloss:"faithful",pos:"adj",freq:45},
  {word:"πνεῦμα",lemma:"πνεῦμα",gloss:"spirit",pos:"noun",freq:200, parse:"N-NSN"},
  {word:"γράφω",lemma:"γράφω",gloss:"to write",pos:"verb",freq:88, parse:"V-PRES-ACT-1S"},
  {word:"ἄνθρωπος",lemma:"ἄνθρωπος",gloss:"man, person",pos:"noun",freq:410, parse:"N-NSM"},
  {word:"ἐν",lemma:"ἐν",gloss:"in",pos:"prep",freq:980}
];

const SAMPLE_HEBREW = [
  {word:"דָּוִד",lemma:"דָּוִד",gloss:"David",pos:"noun",freq:220, parse:"N-NSM"},
  {word:"אֱלֹהִים",lemma:"אֱלֹהִים",gloss:"God",pos:"noun",freq:300, parse:"N-NSM"},
  {word:"אָמַר",lemma:"אָמַר",gloss:"to say",pos:"verb",freq:5317, parse:"V-PAST-3S"},
  {word:"תּוֹרָה",lemma:"תּוֹרָה",gloss:"law, instruction",pos:"noun",freq:190, parse:"N-NSF"},
  {word:"טוֹב",lemma:"טוֹב",gloss:"good",pos:"adj",freq:60},
  {word:"יָד",lemma:"יָד",gloss:"hand",pos:"noun",freq:250, parse:"N-NSF"},
  {word:"שָׁלוֹם",lemma:"שָׁלוֹם",gloss:"peace",pos:"noun",freq:310},
  {word:"בֵּן",lemma:"בֵּן",gloss:"son",pos:"noun",freq:180, parse:"N-NSM"}
];

/* ---------- Init ---------- */
async function init(){
  // load preferences, data, wire events — in safe order
  loadPrefs();
  loadLastLang();
  await loadData();
  // wire events once DOM elements exist
  wireEvents();
  // ensure language UI is in sync
  setLang(state.lang);
  renderList();
  // restore dashboard if present
  try { const d = JSON.parse(localStorage.getItem('pp_dashboard')||'{}'); state.dashboard = d || state.dashboard; } catch(e){}
  const streakEl = $('#streakBadge'); if(streakEl) streakEl.textContent = `Streak: ${state.dashboard.streak||0}`;
  // hook sidebar freq to main slider
  const sidebarFreqEl = $('#sidebarFreq'); const freqEl = $('#freqSlider');
  if(sidebarFreqEl && freqEl){ sidebarFreqEl.value = freqEl.value; $('#sidebarFreqLabel').textContent = (sidebarFreqEl.value >=50)?'50+':sidebarFreqEl.value + '+'; }
  // set theme & accent UI
  document.documentElement.style.setProperty('--accent', state.prefs.accent || DEFAULTS.accent);
  renderAccentButtons();
  renderAll();
}

/* Quick render wrapper */
function renderAll(){ renderList(); renderDashboard(); }

/* Start */
init();

</script>
</body>
</html>
