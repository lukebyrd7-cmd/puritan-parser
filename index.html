<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Puritan Parser</title>
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="logo.png">
<link rel="icon" href="logo.png">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Puritan Parser">
<meta name="theme-color" content="#4e8f6e">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;0,700;0,800;1,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* =============================================
   PURITAN PARSER v3 ‚Äî Enhanced
   ============================================= */
:root {
  --bg: #faf8f4;
  --surface: #ffffff;
  --surface-2: #f5f2ec;
  --card: #fffffe;
  --muted: #7a6e5f;
  --text: #1a1208;
  --text-2: #3d3020;
  --accent: #4e8f6e;
  --accent-dark: #35694e;
  --accent-glow: rgba(78,143,110,0.15);
  --danger: #b91c1c;
  --warn: #c97c06;
  --success: #15803d;
  --border: rgba(120,100,70,0.12);
  --border-strong: rgba(120,100,70,0.22);
  --radius: 10px;
  --radius-sm: 6px;
  --shadow-sm: 0 1px 4px rgba(26,18,8,0.07);
  --shadow: 0 4px 16px rgba(26,18,8,0.08), 0 1px 4px rgba(26,18,8,0.04);
  --shadow-lg: 0 12px 40px rgba(26,18,8,0.12), 0 2px 8px rgba(26,18,8,0.06);
  --font-serif: 'EB Garamond', Georgia, serif;
  --font-mono: 'JetBrains Mono', 'Courier New', monospace;
  --font-sans: system-ui, -apple-system, 'Segoe UI', sans-serif;
}
html.dark {
  --bg: #0d0c0a;
  --surface: #161410;
  --surface-2: #1e1c17;
  --card: #1a1714;
  --muted: #9a8e7a;
  --text: #ede8df;
  --text-2: #c8beaf;
  --border: rgba(200,180,140,0.09);
  --border-strong: rgba(200,180,140,0.18);
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.3);
  --shadow: 0 4px 16px rgba(0,0,0,0.35);
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.45);
}

/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--font-sans);
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  font-size: 15px;
  line-height: 1.6;
  transition: background 200ms, color 200ms;
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: none;
}
button, input, select { font-family: inherit; font-size: inherit; color: inherit; }
button { cursor: pointer; border: none; background: none; }
a { color: var(--accent); }

/* ===== LAYOUT ===== */
.app {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* ===== HEADER ===== */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 10px 0 0;
}
.logo-wrap {
  width: 52px; height: 52px;
  border-radius: 12px;
  border: 1px solid var(--border-strong);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  background: var(--surface);
  box-shadow: var(--shadow-sm);
}
.logo-wrap img { width: 38px; height: 38px; border-radius: 6px; object-fit: cover; }
.app-name {
  font-family: var(--font-serif);
  font-size: 22px; font-weight: 700; letter-spacing: -0.01em;
  line-height: 1.1;
}
.app-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
.header-actions { margin-left: auto; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

/* ===== TOPBAR ===== */
.topbar {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  padding: 10px 14px;
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
.lang-toggle { display: flex; gap: 4px; background: var(--surface-2); border-radius: 8px; padding: 3px; }
.lang-btn {
  padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600;
  color: var(--muted); transition: all 150ms;
  border: 1px solid transparent;
}
.lang-btn.active {
  background: var(--accent); color: #fff;
  box-shadow: 0 2px 6px var(--accent-glow);
}
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.badge {
  padding: 5px 10px; border-radius: 999px; font-size: 12px; font-weight: 600;
  background: var(--surface-2); border: 1px solid var(--border); color: var(--muted);
}
.badge.due-badge { background: var(--accent-glow); border-color: rgba(78,143,110,0.3); color: var(--accent-dark); }
.badge.streak-badge { background: rgba(201,124,6,0.12); border-color: rgba(201,124,6,0.3); color: var(--warn); }

/* ===== BUTTONS ===== */
.btn {
  padding: 7px 14px; border-radius: 8px; font-size: 13px; font-weight: 600;
  transition: all 150ms; border: 1px solid transparent;
  display: inline-flex; align-items: center; gap: 5px;
}
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: var(--accent-dark); }
.btn-ghost { background: transparent; color: var(--text-2); border-color: var(--border-strong); }
.btn-ghost:hover { background: var(--surface-2); }
.btn-danger { background: var(--danger); color: white; }
.btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 6px; }
.btn-icon { padding: 6px; border-radius: 6px; }

/* ===== NAV TABS ===== */
.view-nav { display: flex; gap: 4px; flex-wrap: wrap; }
.nav-tab {
  padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;
  color: var(--muted); transition: all 150ms; border: 1px solid transparent;
}
.nav-tab.active { background: var(--surface-2); color: var(--text); border-color: var(--border); }
.nav-tab:hover:not(.active) { color: var(--text-2); }

/* ===== INPUTS ===== */
.input {
  padding: 7px 10px; border-radius: 8px; border: 1px solid var(--border-strong);
  background: var(--surface); color: var(--text); font-size: 13px;
  transition: border-color 150ms, box-shadow 150ms;
}
.input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
select.input { cursor: pointer; }

/* ===== SHARED FILTER BAR ===== */
.filter-bar {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  padding: 10px 14px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
.filter-bar-group { display: flex; align-items: center; gap: 6px; }
.filter-label { font-size: 12px; color: var(--muted); white-space: nowrap; font-weight: 600; }
.freq-range-wrap { display: flex; align-items: center; gap: 4px; }
.freq-range-wrap .input { width: 72px; }
.freq-range-sep { color: var(--muted); font-size: 12px; }
.due-toggle-wrap { display: flex; align-items: center; gap: 5px; cursor: pointer; }
.due-toggle-wrap input[type="checkbox"] { cursor: pointer; accent-color: var(--accent); }
.filter-entries { font-size: 12px; color: var(--muted); margin-left: auto; white-space: nowrap; }

/* ===== PANELS ===== */
.panel {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: var(--shadow);
  padding: 16px;
}
.panel-title { font-family: var(--font-serif); font-size: 17px; font-weight: 700; color: var(--text); }
.panel-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

/* ===== TABLE ===== */
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--radius-sm); }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { padding: 8px 10px; text-align: left; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; border-bottom: 1px solid var(--border); white-space: nowrap; }
td { padding: 9px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background: var(--surface-2); cursor: pointer; }
.word-cell { font-family: var(--font-serif); font-size: 18px; font-weight: 600; }
.lemma-cell { font-family: var(--font-serif); font-size: 15px; color: var(--text-2); }
.gloss-cell { color: var(--text-2); }
.pos-tag {
  display: inline-block; padding: 2px 7px; border-radius: 999px;
  font-size: 11px; font-weight: 600; background: var(--surface-2); color: var(--muted);
  border: 1px solid var(--border);
}
.mastery-wrap { display: flex; align-items: center; gap: 6px; min-width: 80px; }
.mastery-bar { flex: 1; height: 6px; border-radius: 3px; background: var(--surface-2); overflow: hidden; }
.mastery-fill { height: 100%; border-radius: 3px; transition: width 300ms; }
.mastery-fill.low { background: var(--danger); }
.mastery-fill.mid { background: var(--warn); }
.mastery-fill.high { background: var(--success); }
.mastery-pct { font-size: 11px; font-weight: 700; color: var(--muted); min-width: 26px; }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(26,18,8,0.45);
  display: flex; align-items: center; justify-content: center;
  padding: 16px;
  animation: fadeIn 150ms ease;
}
.modal-overlay.hidden { display: none; }
.modal-box {
  background: var(--card);
  border: 1px solid var(--border-strong);
  border-radius: 14px;
  box-shadow: var(--shadow-lg);
  padding: 24px;
  max-width: 480px;
  width: 100%;
  max-height: 85dvh;
  overflow-y: auto;
  animation: slideDown 200ms ease;
}
.modal-word { font-family: var(--font-serif); font-size: 52px; font-weight: 700; text-align: center; color: var(--text); margin-bottom: 4px; }
.modal-gloss { font-family: var(--font-serif); font-size: 22px; text-align: center; color: var(--muted); margin-bottom: 16px; }
.modal-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.modal-row:last-of-type { border-bottom: none; }
.modal-row-label { color: var(--muted); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; }
.modal-history { margin-top: 12px; }
.modal-history-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-bottom: 6px; }
.history-dots { display: flex; gap: 4px; flex-wrap: wrap; }
.history-dot {
  width: 20px; height: 20px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; font-weight: 700; font-family: var(--font-mono);
  color: white;
}

/* ===== FLASHCARD ===== */
.fc-outer {
  display: flex; flex-direction: column; align-items: center;
  padding: 8px 0 16px;
  gap: 16px;
}
.fc-progress-bar-wrap { width: 100%; max-width: 560px; }
.fc-progress-bar { height: 4px; background: var(--surface-2); border-radius: 2px; overflow: hidden; }
.fc-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 400ms ease; }
.fc-progress-text { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

.fc-scene {
  width: 100%; max-width: 560px;
  perspective: 1400px;
  min-height: 280px;
  touch-action: pan-y;
}
.fc-card {
  width: 100%; min-height: 280px;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 450ms cubic-bezier(0.45, 0, 0.55, 1);
}
.fc-card.flipped { transform: rotateY(180deg); }
.fc-face {
  position: absolute; inset: 0;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  border-radius: var(--radius);
  background: var(--card);
  border: 1px solid var(--border-strong);
  box-shadow: var(--shadow-lg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 36px 28px;
  gap: 8px;
}
.fc-back { transform: rotateY(180deg); justify-content: flex-start; padding-top: 28px; }

.fc-word-display {
  font-family: var(--font-serif);
  font-size: 54px; font-weight: 700; text-align: center; line-height: 1.1;
  color: var(--text);
  letter-spacing: -0.01em;
}
.fc-hint { font-size: 13px; color: var(--muted); }
.fc-pos-tag { font-size: 12px; color: var(--muted); background: var(--surface-2); padding: 3px 8px; border-radius: 999px; border: 1px solid var(--border); }
.fc-flip-btn {
  margin-top: 16px;
  padding: 10px 32px; border-radius: 8px; font-size: 14px; font-weight: 700;
  background: var(--accent); color: white; border: 1px solid transparent;
  transition: all 150ms; box-shadow: 0 2px 8px var(--accent-glow);
}
.fc-flip-btn:hover { background: var(--accent-dark); }
.fc-flip-btn.ghost {
  background: transparent; color: var(--muted);
  border-color: var(--border-strong); box-shadow: none;
}

.fc-back-word { font-family: var(--font-serif); font-size: 32px; font-weight: 600; text-align: center; color: var(--muted); }
.fc-gloss { font-family: var(--font-serif); font-size: 28px; font-weight: 700; text-align: center; color: var(--text); }
.fc-meta-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.fc-parse-tag {
  padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600;
  font-family: var(--font-mono);
  background: var(--surface-2); border: 1px solid var(--border); color: var(--text-2);
}

.fc-rating { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
.fc-rating-btn {
  padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-strong);
  font-size: 13px; font-weight: 700; transition: all 150ms;
  color: var(--text-2); background: var(--surface);
}
.fc-rating-btn:hover { background: var(--accent); color: white; border-color: var(--accent); transform: translateY(-1px); }
.fc-rating-btn.forgot-btn { border-color: rgba(185,28,28,0.4); color: var(--danger); }
.fc-rating-btn.forgot-btn:hover { background: var(--danger); color: white; }
.fc-rating-btn.easy-btn { border-color: rgba(21,128,61,0.4); color: var(--success); }
.fc-rating-btn.easy-btn:hover { background: var(--success); color: white; }

/* Swipe hint */
.swipe-hint { font-size: 11px; color: var(--muted); text-align: center; opacity: 0.7; }

.session-complete {
  display: flex; flex-direction: column; align-items: center; gap: 16px;
  padding: 40px 24px; text-align: center;
}
.session-complete .big-check { font-size: 56px; }
.session-complete h3 { font-family: var(--font-serif); font-size: 26px; font-weight: 700; }
.session-missed-list { width: 100%; max-width: 400px; text-align: left; }
.session-missed-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-bottom: 8px; }
.session-missed-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.session-missed-item:last-child { border-bottom: none; }
.session-missed-word { font-family: var(--font-serif); font-size: 17px; font-weight: 600; }

/* ===== PARSING PRACTICE ===== */
.parsing-wrap { display: flex; flex-direction: column; gap: 14px; }
.parsing-question-word {
  font-family: var(--font-serif); font-size: 48px; font-weight: 700;
  text-align: center; color: var(--text); margin: 16px 0;
}
.parsing-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media (max-width: 480px) { .parsing-form { grid-template-columns: 1fr; } }
.parsing-field label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
.parsing-result {
  padding: 14px 16px; border-radius: var(--radius);
  border: 1px solid var(--border);
  animation: slideDown 200ms ease;
}
.parsing-result.correct { background: rgba(21,128,61,0.08); border-color: rgba(21,128,61,0.3); }
.parsing-result.wrong { background: rgba(185,28,28,0.06); border-color: rgba(185,28,28,0.25); }
.parsing-result-line { font-size: 13px; margin-bottom: 4px; }
.parsing-result-line.ok { color: var(--success); }
.parsing-result-line.err { color: var(--danger); }
.parsing-score-bar { display: flex; gap: 4px; justify-content: center; margin: 8px 0; }
.ps-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--surface-2); border: 1px solid var(--border); transition: background 300ms; }
.ps-dot.correct-dot { background: var(--success); border-color: var(--success); }
.ps-dot.wrong-dot { background: var(--danger); border-color: var(--danger); }

/* Word forms lemma picker */
.lemma-picker-wrap { display: flex; flex-direction: column; gap: 8px; }
.lemma-search { width: 100%; }
.lemma-list {
  max-height: 200px; overflow-y: auto;
  border: 1px solid var(--border-strong);
  border-radius: 8px;
  background: var(--surface);
}
.lemma-item {
  padding: 8px 12px; cursor: pointer; font-family: var(--font-serif); font-size: 16px;
  border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;
  transition: background 100ms;
}
.lemma-item:last-child { border-bottom: none; }
.lemma-item:hover, .lemma-item.selected { background: var(--accent-glow); }
.lemma-item.selected { font-weight: 700; }
.lemma-count { font-size: 11px; color: var(--muted); font-family: var(--font-sans); }

/* ===== DASHBOARD ===== */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
.stat-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 14px 16px; text-align: center;
}
.stat-num { font-family: var(--font-serif); font-size: 32px; font-weight: 800; color: var(--text); line-height: 1; }
.stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-top: 4px; }

.spark-wrap { position: relative; height: 70px; }
canvas { display: block; }

.heatmap-row { display: flex; gap: 3px; flex-wrap: wrap; }
.hm-cell {
  width: 14px; height: 14px; border-radius: 3px;
  background: var(--surface-2); border: 1px solid var(--border);
  transition: background 200ms;
}
.hm-cell[data-v="1"] { background: rgba(78,143,110,0.25); }
.hm-cell[data-v="2"] { background: rgba(78,143,110,0.45); }
.hm-cell[data-v="3"] { background: rgba(78,143,110,0.65); }
.hm-cell[data-v="4"] { background: var(--accent); }

/* Streak warning */
.streak-warning {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; border-radius: 8px;
  background: rgba(201,124,6,0.1); border: 1px solid rgba(201,124,6,0.3);
  color: var(--warn); font-size: 13px; font-weight: 600;
}

/* POS breakdown bar */
.pos-breakdown { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
.pos-pill { padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; background: var(--surface-2); border: 1px solid var(--border); }

/* ===== SETTINGS ===== */
.settings-section { display: flex; flex-direction: column; gap: 6px; }
.settings-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
.color-swatch {
  width: 28px; height: 28px; border-radius: 6px; border: 2px solid transparent;
  cursor: pointer; transition: transform 150ms, border-color 150ms;
}
.color-swatch:hover { transform: scale(1.15); }
.color-swatch.active { border-color: var(--text); }

kbd {
  display: inline-block; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-family: var(--font-mono);
  background: var(--surface-2); border: 1px solid var(--border-strong); color: var(--muted);
}

/* ===== TOAST ===== */
.toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; align-items: center; pointer-events: none; }
.toast {
  padding: 10px 20px; border-radius: 999px; font-size: 13px; font-weight: 600;
  background: var(--text); color: var(--bg);
  box-shadow: var(--shadow-lg); pointer-events: none;
  animation: toastIn 300ms ease, toastOut 300ms ease 2700ms forwards;
}
.toast.success { background: var(--success); color: white; }
.toast.danger { background: var(--danger); color: white; }
@keyframes toastIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
@keyframes toastOut { from { opacity:1; } to { opacity:0; } }

/* ===== EMPTY STATE ===== */
.empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
.empty-state .empty-icon { font-size: 40px; margin-bottom: 10px; }
.empty-state p { font-size: 14px; }

/* ===== UTILS ===== */
.hidden { display: none !important; }
.muted { color: var(--muted); }
.small { font-size: 12px; }
.serif { font-family: var(--font-serif); }
.mono { font-family: var(--font-mono); font-size: 12px; }
.divider { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
.flex { display: flex; }
.flex-center { display: flex; align-items: center; justify-content: center; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }

/* ===== ANIMATIONS ===== */
@keyframes slideDown { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
.fade-in { animation: fadeIn 200ms ease; }

/* ===== FOCUS ===== */
button:focus-visible, input:focus-visible, select:focus-visible {
  outline: 2px solid var(--accent); outline-offset: 2px;
}

/* ===== REDUCED MOTION ===== */
@media (prefers-reduced-motion: reduce) {
  .fc-card { transition: none; }
  * { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
}

/* ===== MOBILE ===== */
@media (max-width: 600px) {
  .app { padding: 10px; gap: 8px; }
  .app-name { font-size: 18px; }
  .fc-word-display { font-size: 42px; }
  .fc-gloss { font-size: 22px; }
  .fc-back-word { font-size: 24px; }
  .header-actions .btn-ghost { display: none; }
  .topbar-right .badge { display: none; }
  .fc-face { padding: 24px 16px; }
  .panel { padding: 12px; }
  .parsing-question-word { font-size: 36px; }
  table { font-size: 12px; }
  .word-cell { font-size: 15px; }
  .fc-rating-btn { padding: 8px 10px; font-size: 12px; }
  .freq-range-wrap .input { width: 56px; }
}

/* ===== TWO-COL DESKTOP ===== */
@media (min-width: 1000px) {
  .main-grid { display: grid; grid-template-columns: 1fr 300px; gap: 14px; align-items: start; }
}
</style>
</head>
<body>

<div class="app" id="app" role="application">

  <!-- TOAST CONTAINER -->
  <div class="toast-container" id="toastContainer" aria-live="polite"></div>

  <!-- WORD DETAIL MODAL -->
  <div class="modal-overlay hidden" id="wordModal" role="dialog" aria-modal="true">
    <div class="modal-box" id="wordModalBox">
      <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
        <button class="btn btn-ghost btn-sm" id="closeModal">‚úï Close</button>
      </div>
      <div class="modal-word" id="modalWord">‚Äî</div>
      <div class="modal-gloss" id="modalGloss">‚Äî</div>
      <div id="modalRows"></div>
      <div class="modal-history" id="modalHistory"></div>
      <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" id="modalResetBtn">‚Ü∫ Reset this word</button>
        <button class="btn btn-primary btn-sm" id="modalCloseBtn2">Done</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="header">
    <div class="logo-wrap" id="logoWrap">
      <img id="logoImg" src="./logo.png" alt="Puritan Parser" onerror="this.onerror=null;this.parentNode.innerHTML=svgFallback">
    </div>
    <div>
      <div class="app-name">The Puritan Parser</div>
      <div class="app-sub">Biblical Greek &amp; Hebrew ‚Äî Spaced Repetition</div>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost btn-sm" id="openSettings" title="Settings (S)">‚öô Settings</button>
    </div>
  </header>

  <!-- TOPBAR -->
  <div class="topbar" role="navigation">
    <div class="lang-toggle" role="tablist">
      <button class="lang-btn" data-lang="greek" id="btnGreek" role="tab">Greek (GNT)</button>
      <button class="lang-btn" data-lang="hebrew" id="btnHebrew" role="tab">Hebrew</button>
    </div>
    <div class="view-nav" id="viewNav">
      <button class="nav-tab active" data-view="list">Word List</button>
      <button class="nav-tab" data-view="flash">Flashcards</button>
      <button class="nav-tab" data-view="parsing">Parsing</button>
      <button class="nav-tab" data-view="dashboard">Dashboard</button>
    </div>
    <div class="topbar-right">
      <div class="badge due-badge" id="dueBadge">Due: 0</div>
      <div class="badge streak-badge" id="streakBadge">üî• 0</div>
    </div>
  </div>

  <!-- SHARED FILTER BAR (visible on list, flash, parsing) -->
  <div class="filter-bar" id="sharedFilterBar">
    <!-- Search: only shown on list view -->
    <div class="filter-bar-group" id="filterSearchGroup">
      <input class="input" id="searchInput" placeholder="üîç Search word, gloss, pos‚Ä¶" style="min-width:160px" autocomplete="off" />
    </div>
    <!-- Freq range -->
    <div class="filter-bar-group">
      <span class="filter-label">Freq</span>
      <div class="freq-range-wrap">
        <input id="freqMin" type="number" class="input" value="1" min="1" max="9999" placeholder="min" title="Min frequency" />
        <span class="freq-range-sep">‚Äì</span>
        <input id="freqMax" type="number" class="input" value="9999" min="1" max="99999" placeholder="max" title="Max frequency" />
      </div>
    </div>
    <!-- Due only toggle -->
    <div class="filter-bar-group">
      <label class="due-toggle-wrap" title="Show only cards due for review">
        <input type="checkbox" id="dueOnlyToggle" />
        <span class="filter-label">Due only</span>
      </label>
    </div>
    <!-- Sort: only shown on list view -->
    <div class="filter-bar-group" id="filterSortGroup">
      <select id="sortSelect" class="input">
        <option value="freq-desc">freq ‚Üì</option>
        <option value="freq-asc">freq ‚Üë</option>
        <option value="due-asc">due ‚Üë</option>
        <option value="mastery-asc">mastery ‚Üë</option>
        <option value="word-az">word A‚ÜíZ</option>
      </select>
    </div>
    <div class="filter-entries" id="filterEntriesCount"></div>
  </div>

  <!-- MAIN CONTENT AREA -->
  <div id="mainArea" style="flex:1">

    <!-- ==================== LIST VIEW ==================== -->
    <div id="listView" class="fade-in">
      <div class="panel" style="padding:0">
        <div class="table-wrap">
          <table id="wordsTable" aria-label="Vocabulary list">
            <thead>
              <tr>
                <th>Word</th>
                <th>Gloss</th>
                <th>POS</th>
                <th>Freq</th>
                <th>Due</th>
                <th>Ease</th>
                <th>Mastery</th>
              </tr>
            </thead>
            <tbody id="wordsTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ==================== FLASH VIEW ==================== -->
    <div id="flashView" class="hidden fade-in">
      <!-- Session controls -->
      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="display:flex;gap:6px;align-items:center">
            <span class="small muted">Study</span>
            <select id="studyMode" class="input">
              <option value="due">Due only</option>
              <option value="all">All filtered</option>
              <option value="new">New only</option>
            </select>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <span class="small muted">Direction</span>
            <select id="cardDirection" class="input">
              <option value="word2gloss">Word ‚Üí Gloss</option>
              <option value="gloss2word">Gloss ‚Üí Word</option>
            </select>
          </div>
          <button class="btn btn-primary" id="startFlashBtn">‚ñ∂ Start Session</button>
          <button class="btn btn-ghost btn-sm hidden" id="endFlashBtn">‚úï End</button>
          <div class="muted small" style="margin-left:auto"><kbd>Space</kbd> flip  <kbd>0‚Äì5</kbd> rate</div>
        </div>
      </div>

      <!-- Card area -->
      <div id="flashSessionArea" class="hidden">
        <div class="fc-outer">
          <div class="fc-progress-bar-wrap">
            <div class="fc-progress-text">
              <span id="flashProgressText">0 / 0</span>
              <span id="flashProgressPct" class="muted small">0%</span>
            </div>
            <div class="fc-progress-bar"><div class="fc-progress-fill" id="flashProgressFill" style="width:0%"></div></div>
          </div>

          <div class="fc-scene" id="fcScene">
            <div class="fc-card" id="fcCard">
              <!-- FRONT -->
              <div class="fc-face" id="fcFront">
                <div class="fc-word-display" id="fcWord">‚Äî</div>
                <div class="fc-pos-tag hidden" id="fcPosHint"></div>
                <button class="fc-flip-btn" id="fcFlipToBack">Reveal ‚Üí</button>
              </div>
              <!-- BACK -->
              <div class="fc-face fc-back" id="fcBack">
                <div class="fc-back-word" id="fcWordBack">‚Äî</div>
                <div class="fc-gloss" id="fcGloss">‚Äî</div>
                <div class="fc-meta-row" id="fcMetaRow"></div>
                <hr class="divider" style="width:100%;margin:10px 0">
                <div class="fc-rating" id="fcRating"></div>
                <button class="fc-flip-btn ghost" id="fcFlipToFront" style="margin-top:12px;font-size:12px">‚Üê Back</button>
              </div>
            </div>
          </div>
          <div class="swipe-hint muted small" id="swipeHint" style="display:none">‚Üê swipe to flip ¬∑ swipe ‚Üë for Good ¬∑ swipe ‚Üì for Again</div>

          <!-- Session complete -->
          <div id="flashComplete" class="session-complete hidden">
            <div class="big-check">‚úÖ</div>
            <h3>Session Complete!</h3>
            <div id="flashCompleteStats" class="muted small"></div>
            <div id="flashMissedList" class="session-missed-list hidden"></div>
            <button class="btn btn-primary" id="flashCompleteBack">Back to List</button>
          </div>
        </div>
      </div>

      <!-- Idle state -->
      <div id="flashIdle" class="panel">
        <div class="empty-state">
          <div class="empty-icon">üé¥</div>
          <p style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px">Ready to study?</p>
          <p>Select a mode above and hit <strong>Start Session</strong>.</p>
          <p class="small muted" style="margin-top:8px">Use <kbd>Space</kbd> to flip, <kbd>0‚Äì5</kbd> to rate. Swipe on mobile.</p>
        </div>
      </div>
    </div>

    <!-- ==================== PARSING VIEW ==================== -->
    <div id="parsingView" class="hidden fade-in">
      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="display:flex;gap:6px;align-items:center">
            <span class="small muted">Mode</span>
            <select id="parsingMode" class="input">
              <option value="mixed">Mixed</option>
              <option value="nouns">Nouns</option>
              <option value="verbs">Verbs</option>
              <option value="wordforms">Word Forms</option>
            </select>
          </div>
          <div style="display:flex;gap:6px;align-items:center" id="parsingCountWrap">
            <span class="small muted">Count</span>
            <input id="parsingCount" type="number" class="input" value="10" min="5" max="100" style="width:70px" />
          </div>
          <button class="btn btn-primary" id="startParsing">‚ñ∂ Start</button>
          <button class="btn btn-ghost btn-sm hidden" id="endParsing">‚úï End</button>
        </div>
        <!-- Word forms lemma picker (hidden unless wordforms mode) -->
        <div id="lemmaPicker" class="hidden" style="margin-top:12px">
          <div class="lemma-picker-wrap">
            <input class="input lemma-search" id="lemmaSearch" placeholder="üîç Search lemmas‚Ä¶" autocomplete="off" />
            <div class="lemma-list" id="lemmaList"></div>
            <div class="small muted" id="lemmaSelected" style="margin-top:4px">No lemma selected</div>
          </div>
        </div>
      </div>

      <div id="parsingIdle" class="panel">
        <div class="empty-state">
          <div class="empty-icon">üî§</div>
          <p style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px">Parsing Practice</p>
          <p>Identify the grammatical form of a word. Choose noun or verb drills, or train all forms of a specific word.</p>
          <p class="small muted" style="margin-top:8px">Words need a <code>parse</code> field in your vocab JSON (e.g. <code>"parse":"N-NSM"</code>).</p>
        </div>
      </div>

      <div id="parsingSession" class="hidden">
        <div class="panel parsing-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted small" id="parsingProgress">1 / 10</div>
            <div class="parsing-score-bar" id="parsingDots"></div>
          </div>
          <div class="parsing-question-word" id="parsingWord">‚Äî</div>
          <div class="fc-meta-row" id="parsingMeta" style="justify-content:center;margin-bottom:8px"></div>
          <div class="parsing-form" id="parsingForm"></div>
          <div style="display:flex;gap:8px;margin-top:4px">
            <button class="btn btn-primary" id="parsingSubmit">Check ‚Üí</button>
            <button class="btn btn-ghost btn-sm" id="parsingReveal">Show answer</button>
          </div>
          <div id="parsingResult" class="hidden parsing-result"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-ghost btn-sm hidden" id="nextParsing">Next ‚Üí</button>
            <button class="btn btn-primary btn-sm hidden" id="finishParsing">Finish ‚úì</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DASHBOARD VIEW ==================== -->
    <div id="dashboardView" class="hidden fade-in">
      <div style="display:grid;gap:12px">
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card"><div class="stat-num" id="dashDue">0</div><div class="stat-label">Due Today</div></div>
          <div class="stat-card"><div class="stat-num" id="dashStreak">0</div><div class="stat-label">Day Streak üî•</div></div>
          <div class="stat-card"><div class="stat-num" id="dashTotal">0</div><div class="stat-label">Total Words</div></div>
          <div class="stat-card"><div class="stat-num" id="dashLearned">0</div><div class="stat-label">Mastered</div></div>
          <div class="stat-card"><div class="stat-num" id="dashRevWeek">0</div><div class="stat-label">Reviews (7d)</div></div>
          <div class="stat-card"><div class="stat-num" id="dashAvgEase">‚Äî</div><div class="stat-label">Avg Ease</div></div>
        </div>

        <!-- Streak warning -->
        <div id="streakWarning" class="streak-warning hidden">
          ‚ö† Study today to keep your streak!
        </div>

        <div class="panel">
          <div class="panel-title" style="margin-bottom:10px">Recent Performance (30 reviews)</div>
          <div class="spark-wrap"><canvas id="perfSpark" height="70"></canvas></div>
        </div>

        <div class="panel">
          <div class="panel-title" style="margin-bottom:10px">Study Activity (60 days)</div>
          <div class="heatmap-row" id="heatmapRow"></div>
          <div class="small muted" style="margin-top:6px">Darker = more reviews</div>
        </div>

        <div class="panel">
          <div class="panel-title" style="margin-bottom:10px">Upcoming Due</div>
          <div id="upcomingDue" class="muted small">‚Äî</div>
          <div id="posDueBreakdown" class="pos-breakdown" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- ==================== SETTINGS VIEW ==================== -->
    <div id="settingsView" class="hidden fade-in">
      <div class="panel" style="max-width:640px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div>
            <div class="panel-title">Settings</div>
            <div class="panel-sub">Appearance, SRS tuning, data management</div>
          </div>
          <button class="btn btn-ghost btn-sm" id="closeSettingsBtn">‚úï Close</button>
        </div>

        <div style="display:flex;flex-direction:column;gap:20px">
          <div class="settings-section">
            <div class="settings-label">Theme</div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-ghost btn-sm theme-btn" data-theme="light">‚òÄ Light</button>
              <button class="btn btn-ghost btn-sm theme-btn" data-theme="dark">üåô Dark</button>
              <button class="btn btn-ghost btn-sm theme-btn" data-theme="system">System</button>
            </div>
          </div>

          <div class="settings-section">
            <div class="settings-label">Accent Color</div>
            <div id="accentPicker" style="display:flex;gap:6px;flex-wrap:wrap"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="customAccent" class="input" placeholder="#rrggbb" style="width:110px" />
              <button class="btn btn-ghost btn-sm" id="applyAccent">Apply</button>
            </div>
          </div>

          <div class="settings-section">
            <div class="settings-label">Card Font Size</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="fontSizeSlider" type="range" min="36" max="72" value="54" style="width:120px" />
              <span class="small muted" id="fontSizeLabel">54px</span>
            </div>
          </div>

          <hr class="divider">

          <div class="settings-section">
            <div class="settings-label">SRS Algorithm</div>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="useSM2" checked />
              <span>Use SM-2 (recommended)</span>
            </label>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <div class="settings-label" style="margin-bottom:4px">Initial ease</div>
              <input id="initialEase" class="input" type="number" step="0.1" value="2.5" style="width:100%" />
            </div>
            <div>
              <div class="settings-label" style="margin-bottom:4px">Min ease</div>
              <input id="minEase" class="input" type="number" step="0.1" value="1.3" style="width:100%" />
            </div>
            <div>
              <div class="settings-label" style="margin-bottom:4px">Daily cap</div>
              <input id="dailyCap" class="input" type="number" value="200" style="width:100%" />
            </div>
            <div>
              <div class="settings-label" style="margin-bottom:4px">New cards/day</div>
              <input id="newPerDay" class="input" type="number" value="20" style="width:100%" />
            </div>
          </div>

          <hr class="divider">

          <div class="settings-section">
            <div class="settings-label">Flashcard Options</div>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="showPosHint" />
              <span>Show POS hint on front</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:6px">
              <input type="checkbox" id="autoNextCard" />
              <span>Auto-advance after rating (600ms)</span>
            </label>
          </div>

          <hr class="divider">

          <div class="settings-section">
            <div class="settings-label">Data</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-ghost btn-sm" id="exportData">‚¨á Export JSON</button>
              <button class="btn btn-ghost btn-sm" id="resetSRS">‚Ü∫ Reset SRS</button>
              <button class="btn btn-danger btn-sm" id="clearAll">üóë Clear All</button>
            </div>
          </div>

          <div class="settings-section">
            <div class="settings-label">Keyboard Shortcuts</div>
            <div class="small muted" style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
              <div><kbd>F</kbd> Flashcards</div>
              <div><kbd>P</kbd> Parsing</div>
              <div><kbd>D</kbd> Dashboard</div>
              <div><kbd>S</kbd> Settings</div>
              <div><kbd>Space</kbd> Flip card</div>
              <div><kbd>0‚Äì5</kbd> Rate card</div>
              <div><kbd>Enter</kbd> Submit parse</div>
              <div><kbd>‚Üí</kbd> Next parse</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /mainArea -->

  <footer style="font-size:11px;color:var(--muted);padding:8px 0;border-top:1px solid var(--border);margin-top:auto">
    The Puritan Parser v3 ‚Äî all data stored locally. <span id="footerLang"></span>
  </footer>

</div><!-- /app -->

<script>
const svgFallback = `<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="#4e8f6e"/><text x="50%" y="54%" font-size="26" text-anchor="middle" fill="#fff" font-family="serif" font-weight="700">PP</text></svg>`;
</script>

<script>
/* ============================================================
   THE PURITAN PARSER v3
   ============================================================ */

const FILE_ALL = 'vocab_all.json';
const FILE_GREEK = 'greek_25plus.json';
const FILE_HEBREW = 'hebrew_60plus.json';
const LS_VOCAB_GREEK = 'pp_vocab_greek';
const LS_VOCAB_HEBREW = 'pp_vocab_hebrew';
const LS_PREFS = 'pp_prefs';
const LS_DASHBOARD = 'pp_dashboard';

const DEFAULTS = {
  accent: '#4e8f6e',
  theme: 'light',
  initialEase: 2.5,
  minEase: 1.3,
  useSM2: true,
  dailyCap: 200,
  newPerDay: 20,
  cardFontSize: 54,
  showPosHint: false,
  autoNextCard: false
};

/* ---------- State ---------- */
let state = {
  lang: 'greek',
  data: { greek: [], hebrew: [] },
  filtered: [],
  prefs: { ...DEFAULTS },
  filters: { query: '', minFreq: 1, maxFreq: 9999, dueOnly: false },
  session: { queue: [], idx: 0, mode: 'due', flipped: false, reviewed: 0, forgotten: 0, total: 0, missedWords: [] },
  dashboard: { streak: 0, lastStudied: '', recent: [], heatmap: {} },
  currentView: 'list'
};

let parsingSession = { questions: [], idx: 0, correct: 0, total: 0, results: [], wordformsLemma: '' };
let selectedLemma = null;
let autoAdvanceTimer = null;

/* ---------- Utilities ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const escHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function todayISO(offsetDays=0){
  const d = new Date(); d.setDate(d.getDate()+offsetDays); return d.toISOString().slice(0,10);
}
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function uid(){ return Math.random().toString(36).slice(2,12); }
function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5); }
function debounce(fn,w=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),w); }; }
function toast(msg, type='', duration=3000){
  const c = $('#toastContainer');
  const el = document.createElement('div');
  el.className = `toast${type?' '+type:''}`;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(()=>{ el.remove(); }, duration);
}

/* ---------- Storage ---------- */
function loadPrefs(){
  try {
    const raw = localStorage.getItem(LS_PREFS);
    state.prefs = Object.assign({}, DEFAULTS, raw ? JSON.parse(raw) : {});
  } catch(e){ state.prefs = {...DEFAULTS}; }
}
function savePrefs(){ localStorage.setItem(LS_PREFS, JSON.stringify(state.prefs)); }
function saveVocab(lang){
  try { localStorage.setItem(lang==='greek'?LS_VOCAB_GREEK:LS_VOCAB_HEBREW, JSON.stringify(state.data[lang])); }
  catch(e){ console.warn('save vocab failed', e); }
}
function loadDashboard(){
  try { const r=localStorage.getItem(LS_DASHBOARD); if(r) state.dashboard=Object.assign({streak:0,lastStudied:'',recent:[],heatmap:{}}, JSON.parse(r)); } catch(e){}
}
function saveDashboard(){ localStorage.setItem(LS_DASHBOARD, JSON.stringify(state.dashboard)); }

/* ---------- SRS ---------- */
function ensureSRS(item){
  if(typeof item.ease !== 'number') item.ease = state.prefs.initialEase || 2.5;
  if(typeof item.interval !== 'number') item.interval = 0;
  if(typeof item.repetitions !== 'number') item.repetitions = 0;
  if(!item.due) item.due = todayISO();
  if(!Array.isArray(item.history)) item.history = [];
  if(!item.id) item.id = `${item.lang||'x'}-${uid()}`;
  return item;
}
function sm2Update(item, quality){
  item.history = item.history || [];
  item.history.push({ date: todayISO(), q: quality });
  if(quality < 3){
    item.repetitions = 0; item.interval = 1;
  } else {
    item.repetitions = (item.repetitions||0)+1;
    if(item.repetitions===1) item.interval=1;
    else if(item.repetitions===2) item.interval=6;
    else item.interval = Math.round((item.interval||1)*(item.ease||2.5));
  }
  item.ease = (item.ease||2.5)+0.1-(5-quality)*(0.08+(5-quality)*0.02);
  item.ease = clamp(item.ease, state.prefs.minEase||1.3, 10);
  const next = new Date(); next.setDate(next.getDate()+(item.interval||1));
  item.due = next.toISOString().slice(0,10);
  return item;
}
function leitnerUpdate(item, quality){
  const success = quality>=3;
  item.repetitions = success ? (item.repetitions||0)+1 : 0;
  item.interval = success ? Math.min(365, Math.max(1, Math.round((item.repetitions||1)*2))) : 1;
  const next = new Date(); next.setDate(next.getDate()+(item.interval||1));
  item.due = next.toISOString().slice(0,10);
  return item;
}
function scheduleUpdate(item, quality){
  if(state.prefs.useSM2) return sm2Update(item, quality);
  return leitnerUpdate(item, quality);
}

/* ---------- Data Loading ---------- */
async function tryFetchJson(path){
  try {
    const r = await fetch(path, {cache:'no-store'});
    if(!r.ok) throw new Error('not ok');
    const j = await r.json();
    if(!Array.isArray(j)) throw new Error('not array');
    return j;
  } catch(e){ return null; }
}
async function loadData(){
  const all = await tryFetchJson(FILE_ALL);
  if(all && all.length){
    const g = all.filter(x=>(x.lang||'greek').toLowerCase()==='greek');
    const h = all.filter(x=>(x.lang||'greek').toLowerCase()==='hebrew');
    state.data.greek = g.map(it=>{ it.lang='greek'; return ensureSRS(it); });
    state.data.hebrew = h.map(it=>{ it.lang='hebrew'; return ensureSRS(it); });
    saveVocab('greek'); saveVocab('hebrew');
    return;
  }
  const gf = await tryFetchJson(FILE_GREEK);
  const hf = await tryFetchJson(FILE_HEBREW);
  ['greek','hebrew'].forEach(lang=>{
    const file = lang==='greek' ? gf : hf;
    const lsKey = lang==='greek' ? LS_VOCAB_GREEK : LS_VOCAB_HEBREW;
    const sample = lang==='greek' ? SAMPLE_GREEK : SAMPLE_HEBREW;
    if(file && file.length){
      state.data[lang] = file.map(it=>{ it.lang=lang; return ensureSRS(it); });
      saveVocab(lang);
    } else {
      try {
        const raw = localStorage.getItem(lsKey);
        state.data[lang] = raw ? JSON.parse(raw) : sample.map(it=>ensureSRS(Object.assign({lang},it)));
      } catch(e){
        state.data[lang] = sample.map(it=>ensureSRS(Object.assign({lang},it)));
      }
    }
  });
}

/* ---------- Theme & Accent ---------- */
function setAccent(hex){
  document.documentElement.style.setProperty('--accent', hex);
  document.documentElement.style.setProperty('--accent-dark', adjustBrightness(hex, -20));
  document.documentElement.style.setProperty('--accent-glow', hexToRgba(hex, 0.15));
  state.prefs.accent = hex; savePrefs(); renderAccentButtons();
}
function hexToRgba(hex, alpha){
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function adjustBrightness(hex, amt){
  let r=parseInt(hex.slice(1,3),16)+amt, g=parseInt(hex.slice(3,5),16)+amt, b=parseInt(hex.slice(5,7),16)+amt;
  const c=v=>clamp(v,0,255).toString(16).padStart(2,'0');
  return `#${c(r)}${c(g)}${c(b)}`;
}
function applyTheme(theme){
  state.prefs.theme = theme;
  document.documentElement.classList.remove('dark','light');
  if(theme==='dark') document.documentElement.classList.add('dark');
  else if(theme==='light') document.documentElement.classList.add('light');
  else {
    if(window.matchMedia?.('(prefers-color-scheme:dark)').matches) document.documentElement.classList.add('dark');
    else document.documentElement.classList.add('light');
  }
  $$('.theme-btn').forEach(b=>b.classList.toggle('active', b.dataset.theme===theme));
  savePrefs();
}
const ACCENTS = ['#4e8f6e','#246b9c','#2a9d8f','#8a2b2b','#d97706','#475569','#6b21a8','#b91c1c','#0ea5a4','#ef4444','#f97316','#06b6d4'];
function renderAccentButtons(){
  const el = $('#accentPicker'); if(!el) return;
  el.innerHTML='';
  ACCENTS.forEach(hex=>{
    const b = document.createElement('button');
    b.className = 'color-swatch' + (state.prefs.accent===hex?' active':'');
    b.style.background = hex; b.title = hex;
    b.setAttribute('aria-label', `Set accent to ${hex}`);
    b.addEventListener('click', ()=>setAccent(hex));
    el.appendChild(b);
  });
}

/* ---------- Filter helpers ---------- */
function readFiltersFromDOM(){
  state.filters.query = ($('#searchInput')?.value||'').toLowerCase().trim();
  state.filters.minFreq = Number($('#freqMin')?.value)||1;
  state.filters.maxFreq = Number($('#freqMax')?.value)||9999;
  state.filters.dueOnly = $('#dueOnlyToggle')?.checked||false;
}
function applyFreqFilter(list){
  const { minFreq, maxFreq, dueOnly } = state.filters;
  const today = todayISO();
  return list.filter(it=>{
    if(!it) return false;
    const freq = it.freq||0;
    if(freq < minFreq) return false;
    if(freq > maxFreq) return false;
    if(dueOnly && it.due > today) return false;
    return true;
  });
}

/* ---------- View Controller ---------- */
function showView(viewId){
  const views = ['listView','flashView','parsingView','dashboardView','settingsView'];
  views.forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.toggle('hidden', id!==viewId); });
  $$('.nav-tab').forEach(t=>t.classList.toggle('active', t.dataset.view===viewId.replace('View','')));
  state.currentView = viewId;

  // Show/hide filter bar and its sub-elements
  const filterBar = $('#sharedFilterBar');
  const noFilterViews = ['dashboardView','settingsView'];
  if(filterBar) filterBar.classList.toggle('hidden', noFilterViews.includes(viewId));
  // search only on list
  const sg = $('#filterSearchGroup'); if(sg) sg.classList.toggle('hidden', viewId!=='listView');
  // sort only on list
  const ssg = $('#filterSortGroup'); if(ssg) ssg.classList.toggle('hidden', viewId!=='listView');
  // entries count only on list
  const ec = $('#filterEntriesCount'); if(ec) ec.classList.toggle('hidden', viewId!=='listView');

  if(viewId==='dashboardView') renderDashboard();
  if(viewId==='listView') renderList();

  const fl = $('#footerLang');
  if(fl) fl.textContent = `${state.lang==='greek'?'Greek (GNT)':'Hebrew'} ‚Äî ${getCurrentList().length} words loaded`;
}

/* ---------- Language ---------- */
function setLang(lang){
  state.lang = lang;
  $$('[data-lang]').forEach(b=>b.classList.toggle('active', b.dataset.lang===lang));
  renderList(); updateDueBadge();
  localStorage.setItem('pp_last_lang', lang);
}
function getCurrentList(){ return state.data[state.lang]||[]; }

/* ---------- Due badge ---------- */
function updateDueBadge(){
  const today = todayISO();
  const due = getCurrentList().filter(it=>it.due<=today).length;
  const db = $('#dueBadge'); if(db){ db.textContent = `Due: ${due}`; db.style.display=due?'':'none'; }
  const sb = $('#streakBadge'); if(sb) sb.textContent = `üî• ${state.dashboard.streak||0}`;
}

/* ---------- Mastery ---------- */
function computeMastery(item){
  const reps = item.repetitions||0;
  const ease = item.ease||2.5;
  const raw = (reps*ease)/((state.prefs.initialEase||2.5));
  return Math.round(clamp(raw/5*100, 0, 100));
}

/* ---------- LIST VIEW ---------- */
function renderList(){
  readFiltersFromDOM();
  const { query, minFreq, maxFreq, dueOnly } = state.filters;
  const sort = $('#sortSelect')?.value||'freq-desc';
  const today = todayISO();
  let list = getCurrentList().filter(it=>{
    if(!it) return false;
    const freq = it.freq||0;
    if(freq < minFreq || freq > maxFreq) return false;
    if(dueOnly && it.due > today) return false;
    if(!query) return true;
    return `${it.word||''} ${it.lemma||''} ${it.gloss||''} ${it.pos||''}`.toLowerCase().includes(query);
  });
  list.sort((a,b)=>{
    if(sort==='freq-desc') return (b.freq||0)-(a.freq||0);
    if(sort==='freq-asc') return (a.freq||0)-(b.freq||0);
    if(sort==='due-asc') return (a.due||'9999').localeCompare(b.due||'9999');
    if(sort==='mastery-asc') return computeMastery(a)-computeMastery(b);
    if(sort==='word-az') return (a.word||'').localeCompare(b.word||'');
    return 0;
  });
  state.filtered = list;
  const ec = $('#filterEntriesCount'); if(ec) ec.textContent = `${list.length} entries`;
  const due = list.filter(it=>it.due<=today).length;
  const db = $('#dueBadge'); if(db){ db.textContent=`Due: ${due}`; }
  const tbody = $('#wordsTbody'); if(!tbody) return;
  if(!list.length){
    tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><div class="empty-icon">üîç</div><p>No entries found. Try expanding the frequency range or clearing the search.</p></td></tr>`;
    return;
  }
  tbody.innerHTML = list.map((it,i)=>{
    const m = computeMastery(it);
    const cls = m>60?'high':m>25?'mid':'low';
    const isDue = it.due<=today;
    const posColor = {noun:'#246b9c',verb:'#8a2b2b',adj:'#d97706',prep:'#475569',adv:'#2a9d8f'}[(it.pos||'').toLowerCase().slice(0,4)]||'#6b7280';
    return `<tr data-idx="${i}" style="cursor:pointer">
      <td class="word-cell">${escHtml(it.word||'')}${isDue?'<span style="color:var(--accent);font-size:10px;margin-left:4px">‚óè</span>':''}</td>
      <td class="gloss-cell">${escHtml(it.gloss||'')}</td>
      <td><span class="pos-tag" style="color:${posColor}">${escHtml(it.pos||'‚Äî')}</span></td>
      <td class="muted small">${escHtml(String(it.freq||0))}</td>
      <td class="muted small">${escHtml(it.due||'‚Äî')}</td>
      <td class="muted small">${typeof it.ease==='number'?it.ease.toFixed(1):'‚Äî'}</td>
      <td><div class="mastery-wrap"><div class="mastery-bar"><div class="mastery-fill ${cls}" style="width:${m}%"></div></div><span class="mastery-pct">${m}</span></div></td>
    </tr>`;
  }).join('');

  // Wire row clicks for modal
  $$('#wordsTbody tr').forEach((tr,i)=>{
    tr.addEventListener('click', ()=>openWordModal(state.filtered[i]));
  });
}

/* ---------- WORD DETAIL MODAL ---------- */
function openWordModal(item){
  if(!item) return;
  $('#modalWord').textContent = item.word||'‚Äî';
  $('#modalGloss').textContent = item.gloss||'‚Äî';
  const rows = [
    ['POS', item.pos||'‚Äî'],
    ['Parse', item.parse||'‚Äî'],
    ['Frequency', item.freq||0],
    ['Due', item.due||'‚Äî'],
    ['Ease', typeof item.ease==='number'?item.ease.toFixed(2):'‚Äî'],
    ['Interval', item.interval ? `${item.interval} day${item.interval!==1?'s':''}` : '‚Äî'],
    ['Repetitions', item.repetitions||0],
    ['Mastery', computeMastery(item)+'%'],
  ];
  $('#modalRows').innerHTML = rows.map(([l,v])=>`<div class="modal-row"><span class="modal-row-label">${l}</span><span>${escHtml(String(v))}</span></div>`).join('');

  // History
  const hist = (item.history||[]).slice(-10);
  const histEl = $('#modalHistory');
  if(hist.length){
    const qualityColor = q => q>=4?'#15803d':q>=3?'#4e8f6e':q>=2?'#c97c06':'#b91c1c';
    histEl.innerHTML = `<div class="modal-history-title">Review History (last ${hist.length})</div>
      <div class="history-dots">${hist.map(h=>`<div class="history-dot" style="background:${qualityColor(h.q)}" title="${h.date}: quality ${h.q}">${h.q}</div>`).join('')}</div>
      <div class="small muted" style="margin-top:4px">${hist[hist.length-1]?.date||''}</div>`;
  } else {
    histEl.innerHTML = `<div class="modal-history-title">Review History</div><div class="small muted">No reviews yet</div>`;
  }

  // Reset button
  $('#modalResetBtn').onclick = ()=>{
    if(!confirm(`Reset SRS data for "${item.word}"?`)) return;
    item.ease = state.prefs.initialEase||2.5;
    item.interval = 0; item.repetitions = 0;
    item.due = todayISO(); item.history = [];
    saveVocab(item.lang||state.lang);
    closeWordModal();
    renderList();
    toast('Word reset.','success');
  };

  $('#wordModal').classList.remove('hidden');
}
function closeWordModal(){
  $('#wordModal').classList.add('hidden');
}

/* ---------- FLASHCARD SESSION ---------- */
function startFlash(){
  readFiltersFromDOM();
  const mode = $('#studyMode')?.value||'due';
  const today = todayISO();
  let pool = applyFreqFilter(getCurrentList());
  if(mode==='due') pool = pool.filter(it=>it.due<=today);
  else if(mode==='new') pool = pool.filter(it=>!it.repetitions||it.repetitions===0);
  if(!pool.length){
    toast('No cards available. Try "All filtered" or expand the frequency range.','danger'); return;
  }
  pool = shuffle(pool);
  const cap = Number(state.prefs.dailyCap||200);
  state.session.queue = pool.slice(0,cap);
  state.session.idx = 0;
  state.session.mode = mode;
  state.session.flipped = false;
  state.session.reviewed = 0;
  state.session.forgotten = 0;
  state.session.total = state.session.queue.length;
  state.session.missedWords = [];

  $('#flashIdle').classList.add('hidden');
  $('#flashSessionArea').classList.remove('hidden');
  $('#flashComplete').classList.add('hidden');
  $('#fcCard').parentElement.classList.remove('hidden');
  $('#endFlashBtn').classList.remove('hidden');
  renderFlashCard();
}
function endFlash(){
  if(autoAdvanceTimer){ clearTimeout(autoAdvanceTimer); autoAdvanceTimer=null; }
  $('#flashSessionArea').classList.add('hidden');
  $('#flashIdle').classList.remove('hidden');
  $('#flashComplete').classList.add('hidden');
  $('#endFlashBtn').classList.add('hidden');
  renderList();
}

function renderFlashCard(){
  const q = state.session.queue;
  const total = state.session.total;
  const done = total - q.length;
  const pct = total ? Math.round(done/total*100) : 0;
  const pt = $('#flashProgressText'); if(pt) pt.textContent = `${done} / ${total}`;
  const pp = $('#flashProgressPct'); if(pp) pp.textContent = `${pct}%`;
  const pf = $('#flashProgressFill'); if(pf) pf.style.width = `${pct}%`;

  setCardFlipped(false);
  if(!q.length){ showSessionComplete(); return; }
  const cur = q[0];
  const dir = $('#cardDirection')?.value||'word2gloss';

  if(dir==='word2gloss'){
    $('#fcWord').textContent = cur.word||'‚Äî';
    $('#fcWordBack').textContent = cur.word||'‚Äî';
    $('#fcGloss').textContent = cur.gloss||'‚Äî';
  } else {
    $('#fcWord').textContent = cur.gloss||'‚Äî';
    $('#fcWordBack').textContent = cur.gloss||'‚Äî';
    $('#fcGloss').textContent = cur.word||'‚Äî';
  }

  const ph = $('#fcPosHint');
  if(ph){ ph.textContent = cur.pos||''; ph.classList.toggle('hidden', !state.prefs.showPosHint); }

  const mr = $('#fcMetaRow'); if(mr){
    mr.innerHTML='';
    if(cur.pos){ const s=document.createElement('span'); s.className='fc-parse-tag'; s.textContent=cur.pos; mr.appendChild(s); }
    if(cur.parse){ const s=document.createElement('span'); s.className='fc-parse-tag'; s.textContent=cur.parse; mr.appendChild(s); }
    if(cur.freq){ const s=document.createElement('span'); s.className='fc-parse-tag'; s.textContent=`freq ${cur.freq}`; mr.appendChild(s); }
  }
  buildRatingButtons();
}

function buildRatingButtons(){
  const rr = $('#fcRating'); if(!rr) return;
  rr.innerHTML='';
  const ratings = [
    {q:0, label:'Again', cls:'forgot-btn', title:'Blackout ‚Äî show again'},
    {q:1, label:'Hard', cls:'', title:'Remembered with difficulty'},
    {q:2, label:'Hmm', cls:'', title:'Slight hesitation'},
    {q:3, label:'Good', cls:'', title:'Recalled correctly'},
    {q:4, label:'Easy', cls:'easy-btn', title:'Perfect, easy recall'},
    {q:5, label:'Perfect', cls:'easy-btn', title:'Perfect, instant recall'}
  ];
  ratings.forEach(r=>{
    const b = document.createElement('button');
    b.className = `fc-rating-btn ${r.cls}`.trim();
    b.title = r.title;
    b.innerHTML = `${r.label}<span class="small muted" style="font-size:10px;display:block">${r.q}</span>`;
    b.addEventListener('click',()=>onRate(r.q));
    rr.appendChild(b);
  });
}

function setCardFlipped(flipped){
  state.session.flipped = flipped;
  $('#fcCard')?.classList.toggle('flipped', flipped);
}

function onRate(quality){
  if(autoAdvanceTimer){ clearTimeout(autoAdvanceTimer); autoAdvanceTimer=null; }
  const q = state.session.queue;
  if(!q.length) return;
  const cur = q[0];
  scheduleUpdate(cur, quality);
  saveVocab(cur.lang||state.lang);
  if(quality<3){
    state.session.forgotten++;
    state.session.missedWords.push(cur);
    q.shift();
    const reinsert = Math.min(4, q.length);
    q.splice(reinsert, 0, cur);
  } else {
    state.session.reviewed++;
    q.shift();
  }
  recordReview(quality);
  if(!q.length){ showSessionComplete(); return; }

  if(state.prefs.autoNextCard){
    autoAdvanceTimer = setTimeout(()=>{ renderFlashCard(); }, 600);
  } else {
    renderFlashCard();
  }
}

function showSessionComplete(){
  $('#flashComplete').classList.remove('hidden');
  const cardEl = $('#fcCard');
  if(cardEl && cardEl.parentElement) cardEl.parentElement.classList.add('hidden');
  const stats = $('#flashCompleteStats');
  if(stats){
    const pct = state.session.total ? Math.round(state.session.reviewed/state.session.total*100) : 0;
    stats.textContent = `${state.session.reviewed} correct ¬∑ ${state.session.forgotten} again ¬∑ ${pct}% recall`;
  }
  // Missed words breakdown
  const missed = state.session.missedWords;
  const ml = $('#flashMissedList');
  if(ml){
    if(missed.length){
      const unique = [...new Map(missed.map(w=>[w.id||w.word,w])).values()];
      ml.innerHTML = `<div class="session-missed-title">Words to focus on (${unique.length})</div>`+
        unique.map(w=>`<div class="session-missed-item"><span class="session-missed-word">${escHtml(w.word||'')}</span><span class="muted small">${escHtml(w.gloss||'')}</span></div>`).join('');
      ml.classList.remove('hidden');
    } else {
      ml.classList.add('hidden');
    }
  }
}

/* ---------- Swipe support ---------- */
function wireSwipe(){
  const scene = $('#fcScene'); if(!scene) return;
  let tx=0, ty=0, startX=0, startY=0, dragging=false;
  scene.addEventListener('touchstart', e=>{
    startX=e.touches[0].clientX; startY=e.touches[0].clientY; dragging=true;
    $('#swipeHint').style.display='block';
  }, {passive:true});
  scene.addEventListener('touchend', e=>{
    if(!dragging) return; dragging=false;
    const dx=e.changedTouches[0].clientX-startX;
    const dy=e.changedTouches[0].clientY-startY;
    const adx=Math.abs(dx), ady=Math.abs(dy);
    if(adx>40&&adx>ady*1.5){
      // horizontal swipe
      if(!state.session.flipped) setCardFlipped(dx>0);
      else setCardFlipped(dx<0);
    } else if(ady>40&&ady>adx*1.5){
      // vertical swipe (only on back)
      if(state.session.flipped){
        if(dy<-40) onRate(3); // swipe up = Good
        else if(dy>40) onRate(0); // swipe down = Again
      }
    }
  }, {passive:true});
}

/* ---------- Session tracking ---------- */
function recordReview(quality){
  const today = todayISO();
  state.dashboard.recent = state.dashboard.recent || [];
  state.dashboard.recent.push({ date: today, q: Number(quality) });
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-90);
  state.dashboard.recent = state.dashboard.recent.filter(r=>new Date(r.date)>=cutoff);
  state.dashboard.heatmap = state.dashboard.heatmap || {};
  state.dashboard.heatmap[today] = (state.dashboard.heatmap[today]||0)+1;
  const dates = Array.from(new Set(state.dashboard.recent.map(r=>r.date))).sort();
  let streak=0; const d=new Date();
  for(let i=0;i<365;i++){
    const iso=d.toISOString().slice(0,10);
    if(dates.includes(iso)){ streak++; d.setDate(d.getDate()-1); } else break;
  }
  state.dashboard.streak = streak;
  state.dashboard.lastStudied = today;
  saveDashboard();
  const sb=$('#streakBadge'); if(sb) sb.textContent=`üî• ${streak}`;
}

/* ---------- PARSING PRACTICE ---------- */
function updateParsingModeUI(){
  const mode = $('#parsingMode')?.value||'mixed';
  const isWordForms = mode==='wordforms';
  $('#parsingCountWrap')?.classList.toggle('hidden', isWordForms);
  $('#lemmaPicker')?.classList.toggle('hidden', !isWordForms);
  if(isWordForms) renderLemmaPicker();
}

function renderLemmaPicker(){
  readFiltersFromDOM();
  const search = ($('#lemmaSearch')?.value||'').toLowerCase();
  const pool = applyFreqFilter(getCurrentList()).filter(it=>it.parse);
  // Group by lemma
  const lemmaMap = {};
  pool.forEach(it=>{
    const l = it.lemma||it.word||'';
    if(!lemmaMap[l]) lemmaMap[l]=0;
    lemmaMap[l]++;
  });
  const lemmas = Object.entries(lemmaMap)
    .filter(([l])=>!search||l.toLowerCase().includes(search))
    .sort((a,b)=>a[0].localeCompare(b[0]));

  const ll = $('#lemmaList'); if(!ll) return;
  if(!lemmas.length){
    ll.innerHTML = `<div class="lemma-item"><span class="muted small">No parseable lemmas found</span></div>`;
    return;
  }
  ll.innerHTML = lemmas.map(([l,cnt])=>
    `<div class="lemma-item${selectedLemma===l?' selected':''}" data-lemma="${escHtml(l)}">`+
    `<span>${escHtml(l)}</span><span class="lemma-count">${cnt} form${cnt!==1?'s':''}</span></div>`
  ).join('');
  $$('#lemmaList .lemma-item').forEach(el=>{
    el.addEventListener('click',()=>{
      selectedLemma = el.dataset.lemma;
      $$('#lemmaList .lemma-item').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      const sd = $('#lemmaSelected'); if(sd) sd.textContent = `Selected: ${selectedLemma}`;
    });
  });
}

function startParsing(){
  readFiltersFromDOM();
  const mode = $('#parsingMode')?.value||'mixed';

  if(mode==='wordforms'){
    if(!selectedLemma){ toast('Please select a lemma first.','danger'); return; }
    const pool = applyFreqFilter(getCurrentList()).filter(it=>it.parse && (it.lemma||it.word||'')=== selectedLemma);
    if(!pool.length){
      toast(`No parseable forms found for "${selectedLemma}".`,'danger'); return;
    }
    parsingSession = { questions: shuffle(pool), idx:0, correct:0, total:pool.length, results:[], wordformsLemma: selectedLemma };
    if(pool.length===1) toast(`Only 1 form found for "${selectedLemma}".`);
    $('#parsingIdle').classList.add('hidden');
    $('#parsingSession').classList.remove('hidden');
    $('#endParsing').classList.remove('hidden');
    renderParsingQuestion();
    return;
  }

  const count = Number($('#parsingCount')?.value)||10;
  let pool = applyFreqFilter(getCurrentList()).filter(it=>it.parse);
  if(mode==='nouns') pool=pool.filter(it=>(it.pos||'').toLowerCase().includes('n'));
  else if(mode==='verbs') pool=pool.filter(it=>(it.pos||'').toLowerCase().includes('v'));
  if(!pool.length){
    toast('No parseable words found. Words need a "parse" field in your vocab JSON (e.g. "parse":"N-NSM").','danger'); return;
  }
  pool = shuffle(pool).slice(0, Math.min(count, pool.length));
  parsingSession = { questions: pool, idx:0, correct:0, total:pool.length, results:[], wordformsLemma: '' };
  $('#parsingIdle').classList.add('hidden');
  $('#parsingSession').classList.remove('hidden');
  $('#endParsing').classList.remove('hidden');
  renderParsingQuestion();
}

function endParsing(){
  $('#parsingSession').classList.add('hidden');
  $('#parsingIdle').classList.remove('hidden');
  $('#endParsing').classList.add('hidden');
}

function renderParsingQuestion(){
  const { idx, questions, total, results, wordformsLemma } = parsingSession;
  const dots = $('#parsingDots');
  if(dots){
    dots.innerHTML = questions.slice(0,total).map((_,i)=>{
      const r = results[i];
      return `<div class="ps-dot ${r===true?'correct-dot':r===false?'wrong-dot':''}"></div>`;
    }).join('');
  }

  const isLast = idx === total-1;
  const isDone = idx >= total;

  if(isDone){
    // Summary
    const pct = total?Math.round(parsingSession.correct/total*100):0;
    const summaryText = wordformsLemma
      ? `You identified ${parsingSession.correct}/${total} forms of ${wordformsLemma} correctly.`
      : `${parsingSession.correct}/${total} correct`;
    $('#parsingWord').innerHTML = `<span style="font-size:40px">${pct>=70?'üéâ':'üìñ'}</span>`;
    $('#parsingForm').innerHTML='';
    $('#parsingMeta').innerHTML='';
    $('#parsingResult').classList.add('hidden');
    $('#parsingProgress').textContent = `Complete: ${parsingSession.correct}/${total} (${pct}%)`;
    $('#parsingSubmit').classList.add('hidden');
    $('#nextParsing').classList.add('hidden');
    $('#finishParsing').classList.add('hidden');
    $('#parsingReveal').classList.add('hidden');
    toast(summaryText, pct>=70?'success':'');
    return;
  }

  const qn = questions[idx];
  $('#parsingWord').textContent = qn.word||'‚Äî';
  if(wordformsLemma){
    $('#parsingProgress').textContent = `Training: ${wordformsLemma} ‚Äî ${idx+1}/${total} forms`;
  } else {
    $('#parsingProgress').textContent = `${idx+1} / ${total}`;
  }
  const pm = $('#parsingMeta');
  if(pm){ pm.innerHTML=''; if(qn.freq){ const s=document.createElement('span'); s.className='fc-parse-tag'; s.textContent=`freq ${qn.freq}`; pm.appendChild(s); } }

  const res = $('#parsingResult'); if(res){ res.classList.add('hidden'); res.innerHTML=''; }
  $('#parsingSubmit').classList.remove('hidden');
  $('#nextParsing').classList.add('hidden');
  $('#finishParsing').classList.add('hidden');
  $('#parsingReveal').classList.remove('hidden');

  const form = $('#parsingForm'); if(!form) return;
  form.innerHTML='';
  const fields = getParsingFields(qn);
  fields.forEach(f=>{
    const div = document.createElement('div'); div.className='parsing-field';
    div.innerHTML = `<label>${escHtml(f.label)}</label>`;
    if(f.type==='select'){
      const s = document.createElement('select'); s.className='input'; s.id='par_'+f.id;
      f.opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; s.appendChild(op); });
      div.appendChild(s);
    } else {
      const inp = document.createElement('input'); inp.type='text'; inp.className='input'; inp.id='par_'+f.id;
      inp.placeholder='type lemma...'; inp.autocomplete='off'; div.appendChild(inp);
    }
    form.appendChild(div);
  });
}

function getParsingFields(qn){
  const p = (qn.parse||'').toLowerCase();
  const isNoun = p.startsWith('n-') || (qn.pos||'').toLowerCase().startsWith('n');
  if(isNoun){
    return [
      {id:'case', label:'Case', type:'select', opts:['nom','acc','gen','dat','voc']},
      {id:'number', label:'Number', type:'select', opts:['sg','pl']},
      {id:'gender', label:'Gender', type:'select', opts:['m','f','n']},
      {id:'lemma', label:'Lemma', type:'text'}
    ];
  } else {
    return [
      {id:'tense', label:'Tense', type:'select', opts:['pres','impf','fut','aor','perf','plup']},
      {id:'voice', label:'Voice', type:'select', opts:['act','mid','pas']},
      {id:'mood', label:'Mood', type:'select', opts:['ind','subj','opt','imp','inf','ptc']},
      {id:'person', label:'Person/Num', type:'select', opts:['1s','2s','3s','1p','2p','3p']},
      {id:'lemma', label:'Lemma', type:'text'}
    ];
  }
}

function checkParsingAnswer(reveal=false){
  const idx = parsingSession.idx;
  const qn = parsingSession.questions[idx];
  if(!qn) return;
  const p = (qn.parse||'').toLowerCase();
  const fields = getParsingFields(qn);
  let correct=0; let total=0; const lines=[];
  fields.forEach(f=>{
    if(f.type==='select'){
      const el = $(`#par_${f.id}`); if(!el) return;
      const val = el.value; total++;
      const ok = p.includes(val);
      if(ok) correct++;
      lines.push({ ok, text: ok ? `‚úì ${f.label}: ${val}` : `‚úó ${f.label}: you said "${val}" ‚Äî expected part of "${qn.parse}"` });
    } else {
      const el = $(`#par_${f.id}`); if(!el) return;
      const val = (el.value||'').trim().toLowerCase(); total++;
      const ok = val===(qn.lemma||'').toLowerCase();
      if(ok) correct++;
      lines.push({ ok, text: ok ? `‚úì Lemma: ${val}` : `‚úó Lemma: you said "${val||'‚Äî'}" ‚Äî correct: "${qn.lemma}"` });
    }
  });
  if(correct===total) parsingSession.correct++;
  parsingSession.results[idx] = (correct===total);
  parsingSession.idx++;

  const res = $('#parsingResult'); if(!res) return;
  const allRight = correct===total;
  res.className = `parsing-result ${allRight?'correct':'wrong'}`;
  res.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${allRight?'‚úÖ Correct!':'‚ùå '+correct+'/'+total+' correct'}</div>`
    + lines.map(l=>`<div class="parsing-result-line ${l.ok?'ok':'err'}">${escHtml(l.text)}</div>`).join('');
  res.classList.remove('hidden');
  $('#parsingSubmit').classList.add('hidden');
  $('#parsingReveal').classList.add('hidden');

  const isLastQuestion = parsingSession.idx >= parsingSession.total;
  if(isLastQuestion){
    $('#nextParsing').classList.add('hidden');
    $('#finishParsing').classList.remove('hidden');
  } else {
    $('#nextParsing').classList.remove('hidden');
    $('#finishParsing').classList.add('hidden');
  }
  renderParsingDots();
}

function renderParsingDots(){
  const dots = $('#parsingDots'); if(!dots) return;
  dots.innerHTML = parsingSession.questions.map((_,i)=>{
    const r = parsingSession.results[i];
    return `<div class="ps-dot ${r===true?'correct-dot':r===false?'wrong-dot':''}"></div>`;
  }).join('');
}

function revealParsingAnswer(){
  const idx = parsingSession.idx;
  const qn = parsingSession.questions[idx];
  if(!qn) return;
  const res = $('#parsingResult'); if(!res) return;
  res.className = 'parsing-result';
  res.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Answer: <span class="mono">${escHtml(qn.parse||'‚Äî')}</span></div>
    <div>Lemma: <span class="serif" style="font-size:16px">${escHtml(qn.lemma||'‚Äî')}</span></div>
    <div>Gloss: ${escHtml(qn.gloss||'‚Äî')}</div>`;
  res.classList.remove('hidden');
  $('#parsingSubmit').classList.add('hidden');
  $('#parsingReveal').classList.add('hidden');
  parsingSession.results[idx] = false;
  parsingSession.idx++;

  const isLastQuestion = parsingSession.idx >= parsingSession.total;
  if(isLastQuestion){
    $('#nextParsing').classList.add('hidden');
    $('#finishParsing').classList.remove('hidden');
  } else {
    $('#nextParsing').classList.remove('hidden');
    $('#finishParsing').classList.add('hidden');
  }
  renderParsingDots();
}

/* ---------- DASHBOARD ---------- */
function renderDashboard(){
  const today = todayISO();
  const list = getCurrentList();
  const due = list.filter(it=>it.due<=today).length;
  const learned = list.filter(it=>(it.repetitions||0)>=3).length;
  const recent7 = (state.dashboard.recent||[]).filter(r=>{
    const d=new Date(r.date); const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-7);
    return d>=cutoff;
  });

  const set = (id,v)=>{ const el=$(id); if(el) el.textContent=v; };
  set('#dashDue', due);
  set('#dashStreak', state.dashboard.streak||0);
  set('#dashTotal', list.length);
  set('#dashLearned', learned);
  set('#dashRevWeek', recent7.length);
  const avg = list.length ? (list.reduce((s,it)=>s+(it.ease||0),0)/list.length).toFixed(2) : '‚Äî';
  set('#dashAvgEase', avg);

  // Streak warning
  const sw = $('#streakWarning');
  if(sw){
    const studiedToday = state.dashboard.lastStudied===today;
    const hasStreak = (state.dashboard.streak||0) > 0;
    sw.classList.toggle('hidden', studiedToday||!hasStreak);
  }

  renderSparkline();
  renderHeatmap();
  renderUpcomingDue(list, today);
}

function renderSparkline(){
  const canvas = $('#perfSpark'); if(!canvas) return;
  const recent = (state.dashboard.recent||[]).slice(-30);
  const W = canvas.offsetWidth||300, H=70;
  canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,W,H);
  if(recent.length<2) return;
  const arr = recent.map(r=>r.q);
  ctx.beginPath();
  arr.forEach((v,i)=>{
    const x=(i/(arr.length-1))*W;
    const y=H-(v/5)*H*0.8-H*0.1;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle=state.prefs.accent||'#4e8f6e'; ctx.lineWidth=2.5;
  ctx.lineJoin='round'; ctx.stroke();
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
  ctx.fillStyle=hexToRgba(state.prefs.accent||'#4e8f6e',0.1); ctx.fill();
}

function renderHeatmap(){
  const el = $('#heatmapRow'); if(!el) return;
  el.innerHTML='';
  const hm = state.dashboard.heatmap||{};
  const max = Math.max(1,...Object.values(hm));
  for(let i=59;i>=0;i--){
    const iso = todayISO(-i);
    const v = hm[iso]||0;
    const level = v===0?0:v/max<0.25?1:v/max<0.5?2:v/max<0.75?3:4;
    const cell = document.createElement('div');
    cell.className='hm-cell'; cell.dataset.v=level;
    cell.title=`${iso}: ${v} review${v!==1?'s':''}`;
    el.appendChild(cell);
  }
}

function renderUpcomingDue(list, today){
  const el=$('#upcomingDue'); if(!el) return;
  const counts={};
  list.forEach(it=>{
    const d=it.due||today;
    if(d>=today) counts[d]=(counts[d]||0)+1;
  });
  const sorted = Object.entries(counts).sort((a,b)=>a[0].localeCompare(b[0])).slice(0,7);
  if(!sorted.length){ el.textContent='No upcoming cards.'; return; }
  el.innerHTML='<div style="display:flex;flex-wrap:wrap;gap:8px">'+
    sorted.map(([d,n])=>`<div class="stat-card" style="padding:8px 12px;min-width:0"><div style="font-weight:700;font-size:14px">${n}</div><div class="small muted">${d===today?'Today':d}</div></div>`).join('')+
    '</div>';

  // POS breakdown for today's due
  const pbd = $('#posDueBreakdown');
  if(pbd){
    const todayDue = list.filter(it=>(it.due||'9999')<=today);
    const byPos = {};
    todayDue.forEach(it=>{
      const p = (it.pos||'other').toLowerCase().slice(0,4);
      const label = p==='noun'?'Nouns':p==='verb'?'Verbs':p==='adj'?'Adj':'Other';
      byPos[label]=(byPos[label]||0)+1;
    });
    pbd.innerHTML = Object.entries(byPos).map(([l,n])=>`<span class="pos-pill">${l}: ${n}</span>`).join('');
  }
}

/* ---------- SETTINGS SYNC ---------- */
function syncSettingsUI(){
  const p = state.prefs;
  const sv = (id,v)=>{ const el=$(id); if(el) el.value=v; };
  const sc = (id,v)=>{ const el=$(id); if(el) el.checked=v; };
  sv('#initialEase', p.initialEase||2.5);
  sv('#minEase', p.minEase||1.3);
  sv('#dailyCap', p.dailyCap||200);
  sv('#newPerDay', p.newPerDay||20);
  sv('#fontSizeSlider', p.cardFontSize||54);
  sc('#useSM2', p.useSM2!==false);
  sc('#showPosHint', !!p.showPosHint);
  sc('#autoNextCard', !!p.autoNextCard);
  $('#fontSizeLabel').textContent = (p.cardFontSize||54)+'px';
  applyTheme(p.theme||'light');
  renderAccentButtons();
}

/* ---------- Export ---------- */
function exportData(){
  const data = { greek: state.data.greek, hebrew: state.data.hebrew, exported: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='puritan-parser-export.json'; a.click();
  URL.revokeObjectURL(url);
  toast('Data exported!','success');
}

/* ---------- Events ---------- */
let eventsWired = false;
function wireEvents(){
  if(eventsWired) return; eventsWired=true;

  // Language
  $$('[data-lang]').forEach(b=>b.addEventListener('click',()=>setLang(b.dataset.lang)));

  // View nav tabs
  $$('.nav-tab').forEach(t=>t.addEventListener('click',()=>{
    const v = t.dataset.view+'View';
    showView(v);
  }));

  // Shared filter bar inputs
  const debouncedRender = debounce(()=>renderList(),150);
  $('#searchInput')?.addEventListener('input', debouncedRender);
  $('#freqMin')?.addEventListener('input', ()=>{ readFiltersFromDOM(); renderList(); });
  $('#freqMax')?.addEventListener('input', ()=>{ readFiltersFromDOM(); renderList(); });
  $('#dueOnlyToggle')?.addEventListener('change', ()=>{ readFiltersFromDOM(); renderList(); });
  $('#sortSelect')?.addEventListener('change', ()=>renderList());

  // Flashcard
  $('#startFlashBtn').addEventListener('click',startFlash);
  $('#endFlashBtn').addEventListener('click',endFlash);
  $('#fcFlipToBack').addEventListener('click',()=>setCardFlipped(true));
  $('#fcFlipToFront').addEventListener('click',()=>setCardFlipped(false));
  $('#flashCompleteBack').addEventListener('click',()=>{ endFlash(); showView('listView'); });

  // Swipe
  wireSwipe();

  // Parsing
  $('#parsingMode')?.addEventListener('change', updateParsingModeUI);
  $('#lemmaSearch')?.addEventListener('input', debounce(renderLemmaPicker, 150));
  $('#startParsing').addEventListener('click',startParsing);
  $('#endParsing').addEventListener('click',endParsing);
  $('#parsingSubmit').addEventListener('click',()=>checkParsingAnswer());
  $('#parsingReveal').addEventListener('click',revealParsingAnswer);
  $('#nextParsing').addEventListener('click',()=>renderParsingQuestion());
  $('#finishParsing').addEventListener('click',()=>{ parsingSession.idx=parsingSession.total; renderParsingQuestion(); });

  // Modal
  $('#closeModal')?.addEventListener('click', closeWordModal);
  $('#modalCloseBtn2')?.addEventListener('click', closeWordModal);
  $('#wordModal')?.addEventListener('click', e=>{ if(e.target===$('#wordModal')) closeWordModal(); });

  // Settings
  $('#openSettings').addEventListener('click',()=>showView('settingsView'));
  $('#closeSettingsBtn').addEventListener('click',()=>showView('listView'));
  $$('.theme-btn').forEach(b=>b.addEventListener('click',()=>applyTheme(b.dataset.theme)));
  $('#applyAccent').addEventListener('click',()=>{
    const v=($('#customAccent').value||'').trim();
    if(/^#[0-9a-f]{6}$/i.test(v)) setAccent(v); else toast('Enter valid hex #rrggbb','danger');
  });

  const srsFields=[['#useSM2','useSM2','bool'],['#initialEase','initialEase','num'],['#minEase','minEase','num'],
    ['#dailyCap','dailyCap','num'],['#newPerDay','newPerDay','num'],
    ['#showPosHint','showPosHint','bool'],['#autoNextCard','autoNextCard','bool']];
  srsFields.forEach(([sel,key,type])=>{
    const el=$(sel); if(!el) return;
    el.addEventListener('change',()=>{
      state.prefs[key] = type==='bool'?el.checked : Number(el.value);
      savePrefs();
    });
  });

  const fss=$('#fontSizeSlider');
  if(fss) fss.addEventListener('input',()=>{
    const v=Number(fss.value);
    state.prefs.cardFontSize=v; savePrefs();
    document.documentElement.style.setProperty('--fc-word-size', v+'px');
    $('#fontSizeLabel').textContent=v+'px';
    $$('.fc-word-display').forEach(el=>el.style.fontSize=v+'px');
  });

  $('#exportData')?.addEventListener('click',exportData);
  $('#resetSRS').addEventListener('click',()=>{
    if(!confirm('Reset SRS data for current language?')) return;
    getCurrentList().forEach(it=>{ it.ease=state.prefs.initialEase; it.interval=0; it.repetitions=0; it.due=todayISO(); it.history=[]; });
    saveVocab(state.lang); renderList(); toast('SRS reset.','success');
  });
  $('#clearAll').addEventListener('click',()=>{
    if(!confirm('Delete ALL local data? This cannot be undone.')) return;
    [LS_VOCAB_GREEK,LS_VOCAB_HEBREW,LS_PREFS,LS_DASHBOARD].forEach(k=>localStorage.removeItem(k));
    location.reload();
  });

  // Keyboard shortcuts
  document.addEventListener('keydown',e=>{
    const tag = document.activeElement.tagName;
    const inInput = tag==='INPUT'||tag==='SELECT'||tag==='TEXTAREA';

    // Modal close
    if(e.key==='Escape'){ closeWordModal(); return; }

    // Global nav shortcuts (skip if in input)
    if(!inInput){
      const fv = document.getElementById('flashView');
      const inFlash = fv&&!fv.classList.contains('hidden');
      if(e.key==='f'||e.key==='F'){ e.preventDefault(); showView('flashView'); }
      else if(e.key==='p'||e.key==='P'){ e.preventDefault(); showView('parsingView'); }
      else if(e.key==='d'||e.key==='D'){ e.preventDefault(); showView('dashboardView'); }
      else if(e.key==='s'||e.key==='S'){ e.preventDefault(); showView('settingsView'); }
      else if(e.key==='l'||e.key==='L'){ e.preventDefault(); showView('listView'); }
      if(inFlash&&state.session.queue.length){
        if(e.key===' '){ e.preventDefault(); setCardFlipped(!state.session.flipped); }
        if(state.session.flipped){
          const k=Number(e.key);
          if(!isNaN(k)&&k>=0&&k<=5){ e.preventDefault(); onRate(k); }
        }
      }
    }

    // Parsing keyboard: Enter to submit/next
    const pv = document.getElementById('parsingView');
    const inParsing = pv&&!pv.classList.contains('hidden');
    if(inParsing){
      const submitBtn = $('#parsingSubmit');
      const nextBtn = $('#nextParsing');
      const finishBtn = $('#finishParsing');
      if(e.key==='Enter'){
        e.preventDefault();
        if(submitBtn&&!submitBtn.classList.contains('hidden')) checkParsingAnswer();
        else if(finishBtn&&!finishBtn.classList.contains('hidden')){ parsingSession.idx=parsingSession.total; renderParsingQuestion(); }
        else if(nextBtn&&!nextBtn.classList.contains('hidden')) renderParsingQuestion();
      }
      if((e.key==='ArrowRight'||e.key==='Tab')&&!e.shiftKey){
        if(nextBtn&&!nextBtn.classList.contains('hidden')){ e.preventDefault(); renderParsingQuestion(); }
      }
    }
  });

  window.addEventListener('beforeunload',()=>{ saveVocab('greek'); saveVocab('hebrew'); savePrefs(); });
  try { if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{}); } catch(e){}
}

/* ---------- Sample Data ---------- */
const SAMPLE_GREEK = [
  {word:"ŒªœåŒ≥ŒøœÇ",lemma:"ŒªœåŒ≥ŒøœÇ",gloss:"word, message",pos:"noun",freq:330,parse:"N-NSM"},
  {word:"ŒªœåŒ≥ŒøŒΩ",lemma:"ŒªœåŒ≥ŒøœÇ",gloss:"word (acc)",pos:"noun",freq:120,parse:"N-ASM"},
  {word:"ŒªœåŒ≥·ø≥",lemma:"ŒªœåŒ≥ŒøœÇ",gloss:"word (dat)",pos:"noun",freq:80,parse:"N-DSM"},
  {word:"·ºÄŒ≥Œ±œÄŒ¨œâ",lemma:"·ºÄŒ≥Œ±œÄŒ¨œâ",gloss:"to love",pos:"verb",freq:143,parse:"V-PRES-ACT-1S"},
  {word:"·º†Œ≥Œ¨œÄŒ∑œÉŒµŒΩ",lemma:"·ºÄŒ≥Œ±œÄŒ¨œâ",gloss:"he loved",pos:"verb",freq:58,parse:"V-AOR-ACT-3S"},
  {word:"Œ∏ŒµœåœÇ",lemma:"Œ∏ŒµœåœÇ",gloss:"God",pos:"noun",freq:1317,parse:"N-NSM"},
  {word:"Œ∏ŒµŒø·ø¶",lemma:"Œ∏ŒµœåœÇ",gloss:"of God",pos:"noun",freq:620,parse:"N-GSM"},
  {word:"Œ∏Œµ·ø∑",lemma:"Œ∏ŒµœåœÇ",gloss:"to God",pos:"noun",freq:190,parse:"N-DSM"},
  {word:"œÄŒπœÉœÑœåœÇ",lemma:"œÄŒπœÉœÑœåœÇ",gloss:"faithful",pos:"adj",freq:67},
  {word:"œÄŒΩŒµ·ø¶ŒºŒ±",lemma:"œÄŒΩŒµ·ø¶ŒºŒ±",gloss:"spirit, wind",pos:"noun",freq:379,parse:"N-NSN"},
  {word:"Œ≥œÅŒ¨œÜœâ",lemma:"Œ≥œÅŒ¨œÜœâ",gloss:"to write",pos:"verb",freq:191,parse:"V-PRES-ACT-1S"},
  {word:"·ºÑŒΩŒ∏œÅœâœÄŒøœÇ",lemma:"·ºÑŒΩŒ∏œÅœâœÄŒøœÇ",gloss:"man, person",pos:"noun",freq:550,parse:"N-NSM"},
  {word:"·ºêŒΩ",lemma:"·ºêŒΩ",gloss:"in, among",pos:"prep",freq:2752},
  {word:"Œ∫œçœÅŒπŒøœÇ",lemma:"Œ∫œçœÅŒπŒøœÇ",gloss:"Lord, master",pos:"noun",freq:717,parse:"N-NSM"},
  {word:"·º∏Œ∑œÉŒø·ø¶œÇ",lemma:"·º∏Œ∑œÉŒø·ø¶œÇ",gloss:"Jesus, Joshua",pos:"noun",freq:917,parse:"N-NSM"},
  {word:"ŒßœÅŒπœÉœÑœåœÇ",lemma:"ŒßœÅŒπœÉœÑœåœÇ",gloss:"Christ, Messiah",pos:"noun",freq:529,parse:"N-NSM"},
  {word:"œÄŒØœÉœÑŒπœÇ",lemma:"œÄŒØœÉœÑŒπœÇ",gloss:"faith, trust",pos:"noun",freq:243,parse:"N-NSF"},
  {word:"·ºÄŒ≥Œ¨œÄŒ∑",lemma:"·ºÄŒ≥Œ¨œÄŒ∑",gloss:"love",pos:"noun",freq:116,parse:"N-NSF"},
  {word:"·ºîœáœâ",lemma:"·ºîœáœâ",gloss:"to have, hold",pos:"verb",freq:708,parse:"V-PRES-ACT-1S"},
  {word:"Œµ·º∞ŒºŒØ",lemma:"Œµ·º∞ŒºŒØ",gloss:"to be, exist",pos:"verb",freq:2461,parse:"V-PRES-ACT-1S"},
  {word:"ŒªŒ≠Œ≥œâ",lemma:"ŒªŒ≠Œ≥œâ",gloss:"to say, speak",pos:"verb",freq:2354,parse:"V-PRES-ACT-1S"}
];
const SAMPLE_HEBREW = [
  {word:"◊ì÷∏÷º◊ï÷¥◊ì",lemma:"◊ì÷∏÷º◊ï÷¥◊ì",gloss:"David",pos:"noun",freq:1075},
  {word:"◊ê÷±◊ú÷π◊î÷¥◊ô◊ù",lemma:"◊ê÷±◊ú÷π◊î÷¥◊ô◊ù",gloss:"God, gods",pos:"noun",freq:2602,parse:"N-MPL"},
  {word:"◊ê÷∏◊û÷∑◊®",lemma:"◊ê÷∏◊û÷∑◊®",gloss:"to say",pos:"verb",freq:5317,parse:"V-QAL-PERF-3MS"},
  {word:"◊™÷º◊ï÷π◊®÷∏◊î",lemma:"◊™÷º◊ï÷π◊®÷∏◊î",gloss:"law, instruction",pos:"noun",freq:220,parse:"N-FSG"},
  {word:"◊ò◊ï÷π◊ë",lemma:"◊ò◊ï÷π◊ë",gloss:"good",pos:"adj",freq:559},
  {word:"◊ô÷∏◊ì",lemma:"◊ô÷∏◊ì",gloss:"hand",pos:"noun",freq:1627,parse:"N-FSG"},
  {word:"◊©÷∏◊Å◊ú◊ï÷π◊ù",lemma:"◊©÷∏◊Å◊ú◊ï÷π◊ù",gloss:"peace, wholeness",pos:"noun",freq:236},
  {word:"◊ë÷µ÷º◊ü",lemma:"◊ë÷µ÷º◊ü",gloss:"son",pos:"noun",freq:4941,parse:"N-MSG"},
  {word:"◊ô÷∞◊î◊ï÷∏◊î",lemma:"◊ô÷∞◊î◊ï÷∏◊î",gloss:"LORD, Yahweh",pos:"noun",freq:6828},
  {word:"◊ë÷µ÷º◊ô◊™",lemma:"◊ë÷∑÷º◊ô÷¥◊™",gloss:"house, home",pos:"noun",freq:2047,parse:"N-MSG"},
  {word:"◊õ÷π÷º◊ú",lemma:"◊õ÷π÷º◊ú",gloss:"all, every",pos:"noun",freq:5415},
  {word:"◊¢÷∏◊©÷∏◊Ç◊î",lemma:"◊¢÷∏◊©÷∏◊Ç◊î",gloss:"to do, make",pos:"verb",freq:2632,parse:"V-QAL-PERF-3MS"}
];

/* ---------- Init ---------- */
async function init(){
  loadPrefs();
  loadDashboard();
  const lastLang = localStorage.getItem('pp_last_lang');
  if(lastLang) state.lang = lastLang;
  applyTheme(state.prefs.theme||'light');
  setAccent(state.prefs.accent||DEFAULTS.accent);
  await loadData();
  wireEvents();
  syncSettingsUI();
  setLang(state.lang);
  showView('listView');
  updateDueBadge();
  if(state.prefs.cardFontSize){
    document.documentElement.style.setProperty('--fc-word-size', state.prefs.cardFontSize+'px');
    $$('.fc-word-display').forEach(el=>el.style.fontSize=state.prefs.cardFontSize+'px');
  }
}

init();
</script>
</body>
</html>
